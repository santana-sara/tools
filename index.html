<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MTA Planner â€” DP6</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
/* â”€â”€â”€ RESET & BASE â”€â”€â”€ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  /* Brand */
  --navy: #0B1D3A;
  --navy-mid: #132847;
  --blue: #1B4FD8;
  --blue-hover: #1540B0;
  --blue-light: #EBF2FF;
  --blue-border: #BFCFFA;

  /* Role colors */
  --de: #0369A1;
  --de-bg: #F0F9FF;
  --de-border: #BAE6FD;
  --de-dark: #075985;
  --ds: #6D28D9;
  --ds-bg: #F5F3FF;
  --ds-border: #C4B5FD;
  --ba: #047857;
  --ba-bg: #ECFDF5;
  --ba-border: #6EE7B7;

  /* Feedback */
  --warn: #92400E;
  --warn-bg: #FFFBEB;
  --warn-border: #FCD34D;
  --danger: #991B1B;
  --danger-bg: #FEF2F2;
  --danger-border: #FCA5A5;
  --success: #065F46;
  --success-bg: #ECFDF5;
  --success-border: #6EE7B7;

  /* Neutrals */
  --bg: #F4F6FA;
  --surface: #FFFFFF;
  --surface-2: #F8FAFD;
  --border: #E3E8F0;
  --border-2: #CBD5E1;
  --text: #0D1829;
  --text-2: #3D5068;
  --text-3: #8A9BB0;

  /* Effects */
  --shadow-sm: 0 1px 3px rgba(11,29,58,.06), 0 1px 8px rgba(11,29,58,.04);
  --shadow: 0 2px 8px rgba(11,29,58,.08), 0 4px 24px rgba(11,29,58,.05);
  --shadow-lg: 0 8px 40px rgba(11,29,58,.12);

  --r: 10px;
  --r-sm: 7px;
  --r-lg: 14px;
}

body {
  font-family: 'Plus Jakarta Sans', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  font-size: 14px;
  line-height: 1.5;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.app-header {
  background: var(--navy);
  height: 58px;
  display: flex;
  align-items: center;
  padding: 0 28px;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: 0 1px 0 rgba(255,255,255,.06);
}

.logo {
  display: flex;
  align-items: center;
  gap: 14px;
}
.logo-mark {
  width: 32px; height: 32px;
  background: linear-gradient(135deg, var(--blue) 0%, #4F8AFF 100%);
  border-radius: 9px;
  display: flex; align-items: center; justify-content: center;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(27,79,216,.4);
}
.logo-text {
  font-size: 15px;
  font-weight: 800;
  color: #fff;
  letter-spacing: -.2px;
}
.logo-divider {
  width: 1px; height: 18px;
  background: rgba(255,255,255,.15);
}
.logo-sub {
  font-size: 12px;
  font-weight: 500;
  color: rgba(255,255,255,.45);
  letter-spacing: .3px;
}

.header-center {
  position: absolute;
  left: 50%; transform: translateX(-50%);
  display: flex;
  align-items: center;
  gap: 6px;
}
.project-pill {
  background: rgba(255,255,255,.08);
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 20px;
  padding: 4px 14px;
  font-size: 12px;
  font-weight: 600;
  color: rgba(255,255,255,.8);
  letter-spacing: .2px;
  transition: all .15s;
}

.role-switcher {
  display: flex;
  align-items: center;
  background: rgba(255,255,255,.07);
  border: 1px solid rgba(255,255,255,.1);
  border-radius: 8px;
  padding: 3px;
  gap: 2px;
}
.role-btn {
  padding: 5px 14px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 700;
  cursor: pointer;
  border: none;
  background: transparent;
  color: rgba(255,255,255,.4);
  font-family: 'Plus Jakarta Sans', sans-serif;
  transition: all .15s;
  letter-spacing: .4px;
}
.role-btn:hover:not(.r-active) { color: rgba(255,255,255,.7); background: rgba(255,255,255,.06); }
.role-btn.r-active { color: #fff; }
.role-btn.r-active.rde { background: var(--de); }
.role-btn.r-active.rds { background: var(--ds); }
.role-btn.r-active.rba { background: var(--ba); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE PROGRESS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stages-bar {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 0 28px;
  display: flex;
  height: 60px;
  align-items: stretch;
  box-shadow: var(--shadow-sm);
}
.stage-step {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1;
  min-width: 0;
  padding: 0 16px 0 0;
  cursor: pointer;
  position: relative;
  transition: opacity .15s;
  opacity: .5;
  user-select: none;
}
.stage-step:first-child { padding-left: 0; }
.stage-step:hover { opacity: .8; }
.stage-step.ss-active { opacity: 1; }
.stage-step.ss-done { opacity: .7; }
.stage-step.ss-active::after,
.stage-step.ss-done::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 16px;
  height: 2.5px;
  border-radius: 2px 2px 0 0;
}
.stage-step.ss-active::after { background: var(--blue); }
.stage-step.ss-done::after { background: var(--ba); }
.ss-bubble {
  width: 28px; height: 28px;
  border-radius: 50%;
  border: 2px solid var(--border-2);
  background: var(--surface);
  display: flex; align-items: center; justify-content: center;
  font-size: 11px; font-weight: 800;
  color: var(--text-3);
  flex-shrink: 0;
  transition: all .2s;
}
.stage-step.ss-active .ss-bubble {
  background: var(--blue);
  border-color: var(--blue);
  color: #fff;
  box-shadow: 0 0 0 4px rgba(27,79,216,.15);
}
.stage-step.ss-done .ss-bubble {
  background: var(--ba-bg);
  border-color: var(--ba);
  color: var(--ba);
}
.ss-info { min-width: 0; }
.ss-num { font-size: 10px; font-weight: 600; color: var(--text-3); letter-spacing: .4px; text-transform: uppercase; }
.ss-name { font-size: 13px; font-weight: 700; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.stage-step.ss-active .ss-name { color: var(--blue); }
.ss-sep { width: 1px; background: var(--border); margin: 16px 0; flex-shrink: 0; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-layout {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: 20px;
  padding: 22px 28px;
  max-width: 1220px;
  margin: 0 auto;
  align-items: start;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CARDS / PANELS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow-sm);
  overflow: hidden;
  transition: box-shadow .15s;
}
.card:hover { box-shadow: var(--shadow); }

.card-head {
  padding: 16px 20px;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.card-title {
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  display: flex;
  align-items: center;
  gap: 8px;
}
.card-title-icon {
  width: 26px; height: 26px;
  border-radius: 7px;
  display: flex; align-items: center; justify-content: center;
  font-size: 13px;
  background: var(--blue-light);
}
.card-desc { font-size: 11px; color: var(--text-3); margin-top: 2px; }
.card-body { padding: 18px 20px; }
.card-section { padding: 16px 20px; border-bottom: 1px solid var(--border); }
.card-section:last-child { border-bottom: none; }
.card-section-label {
  font-size: 10px;
  font-weight: 800;
  text-transform: uppercase;
  letter-spacing: .8px;
  color: var(--text-3);
  margin-bottom: 12px;
}
.card-footer {
  padding: 11px 18px;
  background: var(--surface-2);
  border-top: 1px solid var(--border);
  font-size: 11px;
  color: var(--text-3);
  display: flex;
  align-items: center;
  gap: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ROLE BADGES & TAGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.badge {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 800;
  padding: 2px 8px; border-radius: 4px;
  text-transform: uppercase; letter-spacing: .4px;
}
.badge-de { background: var(--de-bg); color: var(--de); border: 1px solid var(--de-border); }
.badge-ds { background: var(--ds-bg); color: var(--ds); border: 1px solid var(--ds-border); }
.badge-ba { background: var(--ba-bg); color: var(--ba); border: 1px solid var(--ba-border); }
.badge-all { background: var(--bg); color: var(--text-2); border: 1px solid var(--border); }
.badge-auto {
  background: linear-gradient(135deg, #1B4FD8, #6D28D9);
  color: #fff;
  border: none;
  font-size: 9px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FORMS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.field { display: flex; flex-direction: column; gap: 5px; }
.field + .field { margin-top: 14px; }
.field-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.field-grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
.field-label {
  font-size: 12px; font-weight: 700;
  color: var(--text-2);
  display: flex; align-items: center; gap: 6px;
}
.field-label .req { color: var(--danger); }
.field-label .hint { font-weight: 400; color: var(--text-3); }
input[type=text], select, textarea {
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-size: 13px; font-weight: 500;
  padding: 8px 11px;
  border: 1.5px solid var(--border);
  border-radius: var(--r-sm);
  background: var(--surface);
  color: var(--text);
  outline: none;
  transition: border-color .15s, box-shadow .15s;
  width: 100%;
}
input[type=text]:focus, select:focus, textarea:focus {
  border-color: var(--blue);
  box-shadow: 0 0 0 3px rgba(27,79,216,.1);
}
input[type=text]::placeholder { color: var(--text-3); font-weight: 400; }
select { cursor: pointer; }
textarea { resize: vertical; min-height: 72px; line-height: 1.55; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.chips { display: flex; flex-wrap: wrap; gap: 7px; }
.chip {
  padding: 5px 12px;
  border-radius: 20px;
  border: 1.5px solid var(--border);
  font-size: 12px; font-weight: 600;
  cursor: pointer;
  background: var(--surface);
  color: var(--text-2);
  user-select: none;
  transition: all .12s;
  line-height: 1;
}
.chip:hover { border-color: var(--blue); color: var(--blue); background: var(--blue-light); }
.chip.on {
  background: var(--blue-light);
  border-color: var(--blue-border);
  color: var(--blue);
  box-shadow: 0 0 0 1px rgba(27,79,216,.12);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHECKLIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.checklist { display: flex; flex-direction: column; }
.check-row {
  display: flex; align-items: flex-start; gap: 11px;
  padding: 11px 18px;
  cursor: pointer;
  transition: background .1s;
  border-bottom: 1px solid var(--border);
  position: relative;
}
.check-row:last-child { border-bottom: none; }
.check-row:hover { background: var(--surface-2); }
.check-row.checked { background: var(--success-bg); }
.check-row.auto-de { border-left: 3px solid var(--de); }
.check-row.auto-ds { border-left: 3px solid var(--ds); }
.check-row.auto-ba { border-left: 3px solid var(--ba); }
.check-row.crit { border-left: 3px solid var(--danger); }
.chkbox {
  width: 18px; height: 18px;
  border-radius: 5px;
  border: 2px solid var(--border-2);
  flex-shrink: 0; margin-top: 2px;
  display: flex; align-items: center; justify-content: center;
  font-size: 10px; color: transparent;
  background: var(--surface);
  transition: all .12s;
}
.check-row.checked .chkbox {
  background: var(--ba);
  border-color: var(--ba);
  color: #fff;
}
.check-text { font-size: 13px; color: var(--text); line-height: 1.45; flex: 1; }
.check-row.checked .check-text { color: var(--text-3); text-decoration: line-through; }
.check-meta {
  display: flex; align-items: center; gap: 6px;
  margin-top: 4px; font-size: 11px; color: var(--text-3);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ALERTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.alert {
  padding: 12px 14px;
  border-radius: var(--r-sm);
  border: 1px solid transparent;
  font-size: 12px; line-height: 1.55;
  animation: fadeUp .25s ease;
}
.alert-title { font-size: 12px; font-weight: 700; margin-bottom: 3px; }
.alert-body { opacity: .88; }
.alert-info { background: var(--blue-light); border-color: var(--blue-border); color: #1e3a8a; }
.alert-warn { background: var(--warn-bg); border-color: var(--warn-border); color: var(--warn); }
.alert-danger { background: var(--danger-bg); border-color: var(--danger-border); color: var(--danger); }
.alert-success { background: var(--success-bg); border-color: var(--success-border); color: var(--success); }
.alert-de { background: var(--de-bg); border-color: var(--de-border); color: var(--de-dark); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RISK CARDS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.risk-card {
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  overflow: hidden;
  margin-bottom: 8px;
  transition: box-shadow .15s;
}
.risk-card:hover { box-shadow: var(--shadow-sm); }
.risk-head {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px;
  cursor: pointer;
  background: var(--surface);
  transition: background .1s;
}
.risk-head:hover { background: var(--surface-2); }
.risk-level {
  font-size: 9px; font-weight: 800;
  padding: 2px 7px; border-radius: 3px;
  text-transform: uppercase; letter-spacing: .5px;
  flex-shrink: 0;
}
.rl-high { background: var(--danger); color: #fff; }
.rl-med { background: var(--warn-border); color: var(--warn); border: 1px solid currentColor; }
.risk-title { font-size: 12px; font-weight: 700; flex: 1; color: var(--text); }
.risk-chevron { color: var(--text-3); font-size: 11px; transition: transform .2s; }
.risk-head.open .risk-chevron { transform: rotate(180deg); }
.risk-body {
  display: none;
  padding: 11px 14px;
  background: var(--surface-2);
  border-top: 1px solid var(--border);
  font-size: 12px; color: var(--text-2); line-height: 1.55;
}
.risk-body.visible { display: block; }
.risk-action { margin-top: 7px; font-weight: 700; color: var(--de); font-size: 11px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUERY BLOCKS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.query-block {
  border: 1px solid var(--de-border);
  border-radius: var(--r-sm);
  overflow: hidden;
  margin-bottom: 10px;
}
.query-head {
  padding: 10px 14px;
  background: var(--de-bg);
  border-bottom: 1px solid var(--de-border);
  display: flex; align-items: flex-start; justify-content: space-between; gap: 8px;
}
.query-head-info { flex: 1; }
.query-name { font-size: 12px; font-weight: 800; color: var(--de); }
.query-desc { font-size: 10px; color: var(--de); opacity: .7; margin-top: 1px; }
.query-copy-btn {
  font-size: 10px; font-weight: 700;
  padding: 3px 9px;
  border: 1px solid var(--de-border);
  border-radius: 4px;
  background: var(--surface);
  color: var(--de);
  cursor: pointer;
  font-family: 'Plus Jakarta Sans', sans-serif;
  transition: all .12s;
  white-space: nowrap; flex-shrink: 0;
}
.query-copy-btn:hover { background: var(--de-bg); }
.query-code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 11px;
  padding: 13px 15px;
  background: #0D1B3A;
  color: #94A3B8;
  line-height: 1.75;
  overflow-x: auto;
  white-space: pre;
}
.kw { color: #7DD3FC; }
.fn { color: #C084FC; }
.str { color: #86EFAC; }
.cm { color: #3D5068; font-style: italic; }
.num { color: #FCA5A5; }
.op { color: #F472B6; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODEL OPTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.model-opt {
  border: 1.5px solid var(--border);
  border-radius: var(--r-sm);
  padding: 13px 15px;
  cursor: pointer;
  margin-bottom: 8px;
  transition: all .12s;
  position: relative;
}
.model-opt:hover { border-color: var(--blue); background: var(--blue-light); }
.model-opt.selected { border-color: var(--blue); background: var(--blue-light); }
.model-opt-top { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.model-name { font-size: 13px; font-weight: 800; color: var(--text); }
.model-opt.selected .model-name { color: var(--blue); }
.model-rec {
  font-size: 9px; font-weight: 800;
  background: var(--ba);
  color: #fff;
  padding: 2px 7px; border-radius: 3px;
  text-transform: uppercase; letter-spacing: .4px;
}
.model-desc { font-size: 12px; color: var(--text-2); }
.model-opt.selected .model-desc { color: #1e3a8a; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CHANNEL TABLE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ch-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.ch-table thead th {
  text-align: left;
  padding: 8px 12px;
  background: var(--navy);
  color: rgba(255,255,255,.85);
  font-size: 11px; font-weight: 700;
  letter-spacing: .3px;
}
.ch-table thead th:first-child { border-radius: 8px 0 0 0; }
.ch-table thead th:last-child { border-radius: 0 8px 0 0; }
.ch-table tbody td { padding: 8px 12px; border-bottom: 1px solid var(--border); color: var(--text-2); }
.ch-table tbody tr:last-child td { border-bottom: none; }
.ch-table tbody tr:nth-child(even) td { background: var(--surface-2); }
.ch-table tbody tr:hover td { background: var(--blue-light); }
.ch-name { font-weight: 700; color: var(--text); }
.ch-code { font-family: 'JetBrains Mono', monospace; font-size: 10.5px; color: var(--de); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR RIGHT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sidebar-right { display: flex; flex-direction: column; gap: 14px; }

/* Lookback card */
.lw-card {
  background: var(--navy);
  border-radius: var(--r-lg);
  padding: 18px 20px;
  position: relative;
  overflow: hidden;
}
.lw-card::before {
  content: '';
  position: absolute;
  top: -20px; right: -20px;
  width: 90px; height: 90px;
  border-radius: 50%;
  background: rgba(27,79,216,.3);
}
.lw-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: .8px; color: rgba(255,255,255,.4); margin-bottom: 6px; }
.lw-val { font-size: 40px; font-weight: 800; color: #fff; line-height: 1; }
.lw-unit { font-size: 14px; font-weight: 500; color: rgba(255,255,255,.5); margin-left: 4px; }
.lw-sub { font-size: 11px; color: rgba(255,255,255,.5); margin-top: 4px; }
.lw-range {
  margin-top: 12px;
  padding: 8px 10px;
  background: rgba(255,255,255,.07);
  border-radius: 6px;
  font-size: 11px;
  color: rgba(255,255,255,.6);
  font-family: 'JetBrains Mono', monospace;
  line-height: 1.5;
}
.lw-de-note { font-size: 10px; color: #7DD3FC; margin-top: 6px; font-weight: 600; }

/* Summary mini cards */
.mini-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.mini-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: var(--r-sm);
  padding: 11px 13px;
  box-shadow: var(--shadow-sm);
}
.mini-val { font-size: 22px; font-weight: 800; line-height: 1; margin-bottom: 3px; }
.mini-val.blue { color: var(--blue); }
.mini-val.green { color: var(--ba); }
.mini-val.warn { color: var(--warn); }
.mini-val.danger { color: var(--danger); }
.mini-label { font-size: 10px; color: var(--text-3); font-weight: 600; }

/* Alerts stack */
.alerts-stack { display: flex; flex-direction: column; gap: 8px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage-header {
  display: flex; align-items: flex-start; gap: 14px;
  margin-bottom: 20px;
}
.stage-icon-wrap {
  width: 44px; height: 44px;
  border-radius: 12px;
  background: var(--blue);
  display: flex; align-items: center; justify-content: center;
  font-size: 20px;
  box-shadow: 0 4px 12px rgba(27,79,216,.3);
  flex-shrink: 0;
}
.stage-h-title { font-size: 20px; font-weight: 800; color: var(--text); letter-spacing: -.3px; }
.stage-h-desc { font-size: 13px; color: var(--text-2); margin-top: 3px; }
.auto-pill {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: 10px; font-weight: 800;
  background: linear-gradient(135deg, var(--blue), var(--ds));
  color: #fff;
  padding: 3px 9px; border-radius: 20px;
  margin-top: 6px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER ACTIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage-actions {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 14px 20px;
  background: var(--surface-2);
  border-top: 1px solid var(--border);
  margin-top: 16px;
  border-radius: 0 0 var(--r-lg) var(--r-lg);
}
.actions-left { display: flex; align-items: center; gap: 12px; }
.progress-wrap { display: flex; align-items: center; gap: 10px; }
.progress-track { width: 100px; height: 5px; background: var(--border); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; background: var(--blue); transition: width .3s ease; }
.progress-fill.done { background: var(--ba); }
.progress-label { font-size: 11px; color: var(--text-2); font-weight: 600; white-space: nowrap; }

/* Buttons */
.btn {
  display: inline-flex; align-items: center; gap: 7px;
  padding: 8px 18px;
  border-radius: var(--r-sm);
  font-size: 13px; font-weight: 700;
  cursor: pointer; border: none;
  font-family: 'Plus Jakarta Sans', sans-serif;
  transition: all .15s;
  letter-spacing: -.1px;
}
.btn-primary {
  background: var(--blue);
  color: #fff;
  box-shadow: 0 2px 8px rgba(27,79,216,.3);
}
.btn-primary:hover { background: var(--blue-hover); box-shadow: 0 4px 14px rgba(27,79,216,.35); transform: translateY(-1px); }
.btn-ghost {
  background: var(--surface);
  color: var(--text-2);
  border: 1.5px solid var(--border);
}
.btn-ghost:hover { background: var(--surface-2); border-color: var(--border-2); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTION LIST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.q-row {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 16px;
  border-bottom: 1px solid var(--border);
}
.q-row:last-child { border-bottom: none; }
.q-num {
  width: 22px; height: 22px;
  border-radius: 50%;
  background: var(--blue-light);
  border: 1.5px solid var(--blue-border);
  font-size: 10px; font-weight: 800;
  color: var(--blue);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.q-input {
  flex: 1;
  border: none !important;
  border-radius: 0 !important;
  padding: 0 !important;
  background: transparent !important;
  box-shadow: none !important;
  font-size: 13px;
  color: var(--text);
}
.q-input:focus { border: none !important; box-shadow: none !important; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STAGE VISIBILITY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stage-view { display: none; }
.stage-view.sv-active { display: contents; }

/* Role visibility */
.de-panel, .ds-panel, .ba-panel { display: none; }
[data-role=de] .de-panel { display: block; }
[data-role=ds] .ds-panel { display: block; }
[data-role=ba] .ba-panel { display: block; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANIMATIONS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(-8px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes slideIn {
  from { opacity: 0; transform: translateX(-10px); }
  to { opacity: 1; transform: translateX(0); }
}
.fade-up { animation: fadeUp .22s ease forwards; }
.slide-in { animation: slideIn .22s ease forwards; }

/* stagger */
.card:nth-child(1) { animation: fadeUp .2s ease both; }
.card:nth-child(2) { animation: fadeUp .2s .06s ease both; }
.card:nth-child(3) { animation: fadeUp .2s .12s ease both; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MISC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.divider { height: 1px; background: var(--border); margin: 6px 0; }
.stack { display: flex; flex-direction: column; gap: 12px; }
.hidden { display: none !important; }
.chip-add-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-top: 10px;
}
.chip-add-input {
  flex: 1;
  font-size: 12px;
  padding: 5px 10px;
  height: 30px;
  border-radius: 20px;
  border: 1px dashed var(--border-2);
  background: var(--surface-2);
  color: var(--text);
  outline: none;
  transition: border-color .15s;
}
.chip-add-input:focus {
  border-color: var(--blue);
  border-style: solid;
  background: var(--surface);
}
.chip-add-input::placeholder { color: var(--text-3); }
.chip-add-btn {
  font-size: 11px !important;
  padding: 4px 12px !important;
  height: 28px;
  white-space: nowrap;
  border-radius: 20px !important;
}

/* â”€â”€ VALIDATOR PANEL â”€â”€ */
.val-overlay {
  position: fixed; inset: 0;
  background: rgba(11,29,58,.55);
  z-index: 200; display: none;
  align-items: flex-start; justify-content: flex-end;
  backdrop-filter: blur(2px);
}
.val-overlay.open { display: flex; }
.val-panel {
  width: 820px; max-width: 96vw; height: 100vh;
  background: var(--surface);
  box-shadow: -8px 0 40px rgba(11,29,58,.18);
  display: flex; flex-direction: column;
  animation: slideInRight .22s ease; overflow: hidden;
}
@keyframes slideInRight {
  from { transform: translateX(60px); opacity: 0; }
  to   { transform: translateX(0); opacity: 1; }
}
.val-panel-head {
  background: var(--navy); padding: 16px 22px;
  display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
}
.val-panel-title { font-size: 15px; font-weight: 800; color: #fff; display: flex; align-items: center; gap: 10px; }
.val-panel-sub { font-size: 11px; color: rgba(255,255,255,.45); margin-top: 2px; }
.val-close {
  width: 32px; height: 32px; border-radius: 8px;
  background: rgba(255,255,255,.1); border: none; cursor: pointer;
  color: rgba(255,255,255,.7); font-size: 16px;
  display: flex; align-items: center; justify-content: center; transition: background .12s;
}
.val-close:hover { background: rgba(255,255,255,.18); color: #fff; }
.val-tabs { display: flex; border-bottom: 1px solid var(--border); background: var(--surface); flex-shrink: 0; }
.val-tab {
  padding: 11px 20px; font-size: 12px; font-weight: 700; cursor: pointer;
  border-bottom: 2px solid transparent; color: var(--text-3); transition: all .12s;
  border: none; background: transparent; font-family: 'Plus Jakarta Sans', sans-serif;
}
.val-tab:hover { color: var(--text-2); }
.val-tab.vt-active { color: var(--blue); border-bottom: 2px solid var(--blue); }
.val-body { flex: 1; overflow-y: auto; padding: 20px 22px; }
.val-tab-pane { display: none; }
.val-tab-pane.vp-active { display: block; }
.val-status-badge {
  display: inline-flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 20px; font-size: 11px; font-weight: 700;
  cursor: pointer; border: 1px solid rgba(255,255,255,.15);
  background: rgba(255,255,255,.07); color: rgba(255,255,255,.6); transition: all .12s;
}
.val-status-badge:hover { background: rgba(255,255,255,.13); color: #fff; }
.val-status-badge.vb-pass { background: rgba(6,95,70,.4); border-color: rgba(110,231,183,.4); color: #6EE7B7; }
.val-status-badge.vb-warn { background: rgba(146,64,14,.4); border-color: rgba(252,211,77,.4); color: #FCD34D; }
.val-status-badge.vb-fail { background: rgba(153,27,27,.4); border-color: rgba(252,165,165,.4); color: #FCA5A5; }
.val-run-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; padding: 13px; background: var(--blue); color: #fff;
  font-size: 14px; font-weight: 800; border: none; border-radius: var(--r-sm);
  cursor: pointer; font-family: 'Plus Jakarta Sans', sans-serif;
  transition: all .15s; box-shadow: 0 2px 10px rgba(27,79,216,.3); margin-bottom: 16px;
}
.val-run-btn:hover { background: var(--blue-hover); transform: translateY(-1px); }
.val-run-btn:disabled { background: var(--border-2); color: var(--text-3); cursor: not-allowed; transform: none; box-shadow: none; }
.val-run-btn .spin { display: inline-block; animation: spin .7s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }
.dim-card { border: 1px solid var(--border); border-radius: var(--r-sm); overflow: hidden; margin-bottom: 8px; }
.dim-card-head { display: flex; align-items: center; gap: 10px; padding: 10px 14px; cursor: pointer; background: var(--surface); }
.dim-card-head:hover { background: var(--surface-2); }
.dim-card-body { display: none; padding: 12px 14px; background: var(--surface-2); border-top: 1px solid var(--border); font-size: 12px; color: var(--text-2); line-height: 1.6; }
.dim-card-body.dc-open { display: block; }
.dim-label { font-size: 12px; font-weight: 700; flex: 1; }
.status-pill { font-size: 10px; font-weight: 800; padding: 2px 8px; border-radius: 4px; flex-shrink: 0; }
.sp-pass { background: var(--success-bg); color: var(--success); border: 1px solid var(--success-border); }
.sp-warn { background: var(--warn-bg); color: var(--warn); border: 1px solid var(--warn-border); }
.sp-fail { background: var(--danger-bg); color: var(--danger); border: 1px solid var(--danger-border); }
.thr-row { display: grid; grid-template-columns: 1fr auto auto; gap: 10px; align-items: center; padding: 9px 0; border-bottom: 1px solid var(--border); }
.thr-row:last-child { border-bottom: none; }
.thr-name { font-size: 12px; font-weight: 600; color: var(--text); }
.thr-desc { font-size: 11px; color: var(--text-3); margin-top: 2px; }
.thr-input { width: 72px; font-size: 12px; text-align: right; }

</style>
</head>
<body data-role="de">

<!-- â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â• -->
<header class="app-header">
  <div class="logo">
    <div class="logo-mark">ğŸ“Š</div>
    <span class="logo-text">MTA Planner</span>
    <div class="logo-divider"></div>
    <span class="logo-sub">DP6</span>
  </div>

  <div class="header-center">
    <div class="project-pill" id="hdr-project">ğŸ“‹ Novo Projeto</div>
  </div>

  <div style="display:flex;align-items:center;gap:10px;">
    <button class="val-status-badge" id="val-badge" onclick="openValidator()">
      ğŸ” Validador <span id="val-badge-text">nÃ£o executado</span>
    </button>
    <div class="role-switcher">
      <button class="role-btn rde r-active" id="rb-de" onclick="setRole('de')">DE</button>
      <button class="role-btn rds" id="rb-ds" onclick="setRole('ds')">DS</button>
      <button class="role-btn rba" id="rb-ba" onclick="setRole('ba')">BA</button>
    </div>
  </div>
</header>

<!-- â•â• VALIDATOR OVERLAY â•â• -->
<div class="val-overlay" id="val-overlay" onclick="closeValidatorOutside(event)">
  <div class="val-panel">
    <div class="val-panel-head">
      <div>
        <div class="val-panel-title">ğŸ” MTA Source Validator</div>
        <div class="val-panel-sub">Valida qualidade das fontes GA4 + Appsflyer antes de construir a SOT</div>
      </div>
      <button class="val-close" onclick="closeValidator()">âœ•</button>
    </div>
    <div class="val-tabs">
      <button class="val-tab vt-active" onclick="switchValTab('config')">âš™ï¸ 1. ConfiguraÃ§Ã£o</button>
      <button class="val-tab" onclick="switchValTab('colab')">ğŸ”§ 2. Colab (DE)</button>
      <button class="val-tab" onclick="switchValTab('results')">ğŸ“Š 3. Resultados</button>
    </div>
    <div class="val-body">

      <!-- TAB CONFIG -->
      <div class="val-tab-pane vp-active" id="vtp-config">
        <div style="font-size:13px;font-weight:700;margin-bottom:14px;">ParÃ¢metros do cliente <span class="badge badge-ba" style="margin-left:6px;">BA preenche</span></div>
        <div class="field-grid" style="margin-bottom:14px;">
          <div class="field"><div class="field-label">Cliente <span class="req">*</span></div><input type="text" id="vc-client" placeholder="Ex: banco_inter"></div>
          <div class="field"><div class="field-label">Project ID (GCP)</div><input type="text" id="vc-project" placeholder="dp6-cliente-prod"></div>
        </div>
        <div class="field-grid" style="margin-bottom:16px;">
          <div class="field"><div class="field-label">Dataset GA4</div><input type="text" id="vc-ga4" placeholder="analytics_123456789"></div>
          <div class="field"><div class="field-label">Dataset Appsflyer</div><input type="text" id="vc-af" placeholder="appsflyer_data"></div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:14px;margin-bottom:14px;">
          <div class="field-label" style="margin-bottom:8px;">Eventos de conversÃ£o <span class="badge badge-all" style="margin-left:4px;">confirmar nomes com DE</span></div>
          <div class="chips" id="vc-conv-chips">
            <div class="chip on" onclick="chip(this)">purchase</div>
            <div class="chip" onclick="chip(this)">generate_lead</div>
            <div class="chip" onclick="chip(this)">lead</div>
            <div class="chip" onclick="chip(this)">sign_up</div>
            <div class="chip" onclick="chip(this)">app_install</div>
            <div class="chip" onclick="chip(this)">af_purchase</div>
          </div>
          <div style="display:flex;gap:8px;margin-top:8px;">
            <input type="text" id="vc-conv-custom" placeholder="Evento personalizado..." style="flex:1;font-size:12px;">
            <button class="btn btn-ghost" style="font-size:12px;padding:5px 10px;" onclick="addVcConv()">+ Add</button>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:14px;margin-bottom:14px;">
          <div class="field-label" style="margin-bottom:10px;">Mapeamento de variaÃ§Ãµes de canal</div>
          <div id="vc-canal-list">
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;"><div style="font-size:11px;font-weight:700;color:var(--de);">paid_social</div><input type="text" value="Paid Social, paid-social, facebook, meta" style="font-size:11px;"></div>
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;"><div style="font-size:11px;font-weight:700;color:var(--de);">paid_search</div><input type="text" value="Paid Search, cpc, google, adwords" style="font-size:11px;"></div>
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;"><div style="font-size:11px;font-weight:700;color:var(--de);">organic</div><input type="text" value="organic, Organic Search" style="font-size:11px;"></div>
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;"><div style="font-size:11px;font-weight:700;color:var(--de);">email</div><input type="text" value="email, Email, newsletter" style="font-size:11px;"></div>
            <div style="display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;"><div style="font-size:11px;font-weight:700;color:var(--de);">direct</div><input type="text" value="direct, (none)" style="font-size:11px;"></div>
          </div>
          <button class="btn btn-ghost" style="font-size:12px;padding:5px 10px;margin-top:4px;" onclick="addVcCanal()">+ Canal</button>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:14px;">
          <div class="field-label" style="margin-bottom:10px;">Thresholds de qualidade</div>
          <div class="thr-row"><div><div class="thr-name">Lookback window</div><div class="thr-desc">Dias antes da conversÃ£o a considerar</div></div><input class="thr-input" type="text" id="vc-lw" value="30"><div style="font-size:11px;color:var(--text-3);">dias</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ­n. histÃ³rico disponÃ­vel</div><div class="thr-desc">Dias mÃ­nimos na fonte</div></div><input class="thr-input" type="text" id="vc-hist" value="90"><div style="font-size:11px;color:var(--text-3);">dias</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ­n. cobertura user_id</div><div class="thr-desc">Nas conversÃµes da GA4</div></div><input class="thr-input" type="text" id="vc-uid" value="40"><div style="font-size:11px;color:var(--text-3);">%</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ¡x. taxa de duplicatas</div><div class="thr-desc">Nos eventos de conversÃ£o</div></div><input class="thr-input" type="text" id="vc-dup" value="1"><div style="font-size:11px;color:var(--text-3);">%</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ¡x. divergÃªncia GA4 vs AF</div><div class="thr-desc">Volume diÃ¡rio de conversÃµes</div></div><input class="thr-input" type="text" id="vc-div" value="20"><div style="font-size:11px;color:var(--text-3);">%</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ¡x. UTMs nulos</div><div class="thr-desc">Sem source/medium vÃ¡lido</div></div><input class="thr-input" type="text" id="vc-utm" value="30"><div style="font-size:11px;color:var(--text-3);">%</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ­n. conversÃµes/dia</div><div class="thr-desc">Para o modelo ser confiÃ¡vel</div></div><input class="thr-input" type="text" id="vc-vol" value="5"><div style="font-size:11px;color:var(--text-3);">eventos</div></div>
          <div class="thr-row"><div><div class="thr-name">MÃ­n. advertising_id (AF)</div><div class="thr-desc">Cobertura de ID no app</div></div><input class="thr-input" type="text" id="vc-adid" value="60"><div style="font-size:11px;color:var(--text-3);">%</div></div>
        </div>
      </div>

      <!-- TAB COLAB -->
      <div class="val-tab-pane" id="vtp-colab">
        <!-- Step indicator -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;">
          <div style="width:22px;height:22px;border-radius:50%;background:var(--ba);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">âœ“</div>
          <div style="font-size:12px;color:var(--text-3);">ConfiguraÃ§Ã£o preenchida pela BA</div>
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <div style="width:22px;height:22px;border-radius:50%;background:var(--de);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">2</div>
          <div style="font-size:12px;font-weight:700;color:var(--de);">DE executa no Colab</div>
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <div style="width:22px;height:22px;border-radius:50%;background:var(--border);color:var(--text-3);font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
          <div style="font-size:12px;color:var(--text-3);">Resultado importado</div>
        </div>

        <!-- CONFIG gerado -->
        <div style="background:var(--de-bg);border:1px solid var(--de-border);border-radius:var(--r-sm);overflow:hidden;margin-bottom:16px;">
          <div style="padding:10px 14px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--de-border);">
            <div>
              <div style="font-size:12px;font-weight:800;color:var(--de);">CONFIG Python â€” cole na CÃ©lula 2 do Colab</div>
              <div style="font-size:11px;color:var(--de);opacity:.7;margin-top:1px;">Gerado automaticamente a partir da aba ConfiguraÃ§Ã£o</div>
            </div>
            <button class="btn btn-ghost" style="font-size:11px;padding:4px 10px;color:var(--de);border-color:var(--de-border);" onclick="copyValConfig()">ğŸ“‹ Copiar</button>
          </div>
          <pre id="val-config-out" style="font-family:'JetBrains Mono',monospace;font-size:10.5px;padding:13px 14px;background:#0D1B3A;color:#94A3B8;margin:0;line-height:1.75;white-space:pre-wrap;max-height:260px;overflow-y:auto;"></pre>
        </div>

        <!-- Checklist DE -->
        <div style="margin-bottom:16px;">
          <div style="font-size:12px;font-weight:700;color:var(--text-2);margin-bottom:8px;">Checklist DE â€” antes de executar</div>
          <div class="checklist" style="border:1px solid var(--border);border-radius:var(--r-sm);overflow:hidden;">
            <div class="check-row auto-de" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div style="flex:1;"><div class="check-text">Colar o CONFIG acima na CÃ©lula 2 do notebook</div><div class="check-meta"><span class="badge badge-auto">âœ¨ AUTO</span> CONFIG jÃ¡ gerado com os parÃ¢metros da BA</div></div></div>
            <div class="check-row" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div class="check-text">Confirmar acesso ao projeto GCP e datasets corretos</div></div>
            <div class="check-row" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div class="check-text">Verificar nomes exatos das tabelas GA4 e Appsflyer no BigQuery</div></div>
            <div class="check-row" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div class="check-text">Confirmar nomes dos eventos de conversÃ£o nas tabelas reais</div></div>
            <div class="check-row" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div class="check-text">Substituir dados mockados pelas queries reais (CÃ©lula 3)</div></div>
            <div class="check-row" onclick="toggleCheck(this)"><div class="chkbox">âœ“</div><div class="check-text">Executar todas as cÃ©lulas em ordem (Ctrl+Enter)</div></div>
          </div>
        </div>

        <!-- Link Colab -->
        <div style="background:var(--surface-2);border:1px solid var(--border);border-radius:var(--r-sm);padding:12px 14px;margin-bottom:16px;display:flex;align-items:center;gap:10px;">
          <div style="font-size:20px;">ğŸ““</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:700;">Abrir notebook no Google Colab</div>
            <div style="font-size:11px;color:var(--text-3);margin-top:2px;">MTA_Source_Validator.ipynb â€” execute apÃ³s colar o CONFIG</div>
          </div>
          <button class="btn btn-ghost" style="font-size:12px;padding:5px 12px;white-space:nowrap;" onclick="alert('Link do Colab nÃ£o configurado. Cole a URL do seu notebook aqui.')">Abrir â†—</button>
        </div>

        <!-- PrÃ³ximo passo -->
        <div class="alert alert-info">
          <div class="alert-title">ğŸ“‹ ApÃ³s executar o Colab</div>
          <div class="alert-body">Na Ãºltima cÃ©lula do notebook, rode: <code style="font-family:'JetBrains Mono',monospace;background:rgba(0,0,0,.08);padding:1px 5px;border-radius:3px;">validator.to_dataframe().to_json(orient='records')</code><br>Copie o JSON gerado e cole na aba <strong>3. Resultados</strong>.</div>
        </div>
      </div>

      <!-- TAB RESULTS -->
      <div class="val-tab-pane" id="vtp-results">
        <!-- step indicator -->
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:18px;">
          <div style="width:22px;height:22px;border-radius:50%;background:var(--ba);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">âœ“</div>
          <div style="font-size:12px;color:var(--text-3);">Config (BA)</div>
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <div style="width:22px;height:22px;border-radius:50%;background:var(--de);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">âœ“</div>
          <div style="font-size:12px;color:var(--text-3);">Colab (DE)</div>
          <div style="flex:1;height:1px;background:var(--border);"></div>
          <div style="width:22px;height:22px;border-radius:50%;background:var(--blue);color:#fff;font-size:11px;font-weight:800;display:flex;align-items:center;justify-content:center;flex-shrink:0;">3</div>
          <div style="font-size:12px;font-weight:700;color:var(--blue);">Importar resultado</div>
        </div>

        <!-- JSON input -->
        <div id="vr-input-area">
          <div style="font-size:12px;font-weight:700;color:var(--text-2);margin-bottom:6px;">Cole o JSON do relatÃ³rio <span style="font-weight:400;color:var(--text-3);">â€” saÃ­da do <code style="font-family:'JetBrains Mono',monospace;background:var(--bg);padding:1px 5px;border-radius:3px;">validator.to_dataframe().to_json(orient='records')</code></span></div>
          <textarea id="vr-json" placeholder='[{"dimension":"Cobertura Temporal","status":"PASS","metric":"dias_disponiveis_ga4","value":88,...}]' style="width:100%;min-height:90px;font-family:'JetBrains Mono',monospace;font-size:11px;resize:vertical;margin-bottom:10px;"></textarea>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-ghost" style="font-size:12px;padding:6px 12px;" onclick="loadMockJson()">â–¶ Carregar exemplo</button>
            <button class="btn btn-primary" style="font-size:12px;padding:6px 14px;" onclick="processJson()">Processar resultado â†’</button>
          </div>
        </div>

        <!-- Resultado renderizado -->
        <div id="vr-empty" style="text-align:center;padding:32px 20px;color:var(--text-3);display:none;">
          <div style="font-size:28px;margin-bottom:8px;">ğŸ“‹</div>
          <div style="font-size:13px;font-weight:600;">Cole o JSON acima e clique em Processar</div>
        </div>
        <div id="vr-content" style="display:none;margin-top:20px;">
          <div style="height:1px;background:var(--border);margin-bottom:16px;"></div>
          <div id="vr-banner" style="border-radius:var(--r-sm);padding:14px 16px;margin-bottom:16px;"></div>
          <div style="font-size:12px;font-weight:700;color:var(--text-2);margin-bottom:10px;">Resultado por dimensÃ£o <span style="font-size:11px;font-weight:400;color:var(--text-3);">&mdash; clique para expandir</span></div>
          <div id="vr-dims"></div>
          <div id="vr-issues" style="margin-top:14px;"></div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STAGES BAR â•â•â•â•â•â•â•â•â•â• -->
<div class="stages-bar">
  <div class="stage-step ss-active" id="ss-1" onclick="goTo(1)">
    <div class="ss-bubble" id="sb-1">1</div>
    <div class="ss-info">
      <div class="ss-num">Etapa 1</div>
      <div class="ss-name">Entrevistas</div>
    </div>
  </div>
  <div class="ss-sep"></div>
  <div class="stage-step" id="ss-2" onclick="goTo(2)">
    <div class="ss-bubble" id="sb-2">2</div>
    <div class="ss-info">
      <div class="ss-num">Etapa 2</div>
      <div class="ss-name">Mapeamento</div>
    </div>
  </div>
  <div class="ss-sep"></div>
  <div class="stage-step" id="ss-3" onclick="goTo(3)">
    <div class="ss-bubble" id="sb-3">3</div>
    <div class="ss-info">
      <div class="ss-num">Etapa 3</div>
      <div class="ss-name">DiagnÃ³stico</div>
    </div>
  </div>
  <div class="ss-sep"></div>
  <div class="stage-step" id="ss-4" onclick="goTo(4)">
    <div class="ss-bubble" id="sb-4">4</div>
    <div class="ss-info">
      <div class="ss-num">Etapa 4</div>
      <div class="ss-name">ConstruÃ§Ã£o</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ETAPA 1 â€” ENTREVISTAS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-view sv-active" id="view-1">
<div class="page-layout">

  <!-- MAIN -->
  <div class="stack">

    <!-- Stage header -->
    <div class="stage-header">
      <div class="stage-icon-wrap">ğŸ™ï¸</div>
      <div>
        <div class="stage-h-title">Entrevistas</div>
        <div class="stage-h-desc">Capture o contexto de negÃ³cio, mÃ­dias e objetivos. As respostas alimentam automaticamente as etapas seguintes.</div>
      </div>
    </div>

    <!-- NegÃ³cio -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">
            <div class="card-title-icon">ğŸ¢</div>
            Contexto de NegÃ³cio
          </div>
          <div class="card-desc">InformaÃ§Ãµes base sobre o cliente e os objetivos do projeto</div>
        </div>
        <span class="badge badge-all">Todos</span>
      </div>

      <div class="card-section">
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Cliente <span class="req">*</span></div>
            <input type="text" id="f-cliente" placeholder="Nome do cliente" oninput="onInput()">
          </div>
          <div class="field">
            <div class="field-label">Produto / ServiÃ§o principal</div>
            <input type="text" id="f-produto" placeholder="Ex: Abertura de conta digital" oninput="onInput()">
          </div>
        </div>
        <div class="field" style="margin-top:14px;">
          <div class="field-label">Objetivo central do MTA <span class="req">*</span> <span class="hint">â€” o que o cliente quer descobrir?</span></div>
          <select id="f-obj" onchange="onInput()">
            <option value="">Selecione o objetivo...</option>
            <option value="canib">Entender canibalizaÃ§Ã£o entre canais</option>
            <option value="otimizar">Otimizar investimento por canal / funil</option>
            <option value="awareness">Justificar investimento em awareness</option>
            <option value="jornada">Entender a jornada completa do usuÃ¡rio</option>
            <option value="omni">AnÃ¡lise omnichannel (web + app + offline)</option>
          </select>
        </div>
        <div class="field-grid" style="margin-top:14px;">
          <div class="field">
            <div class="field-label">Ciclo de decisÃ£o do consumidor</div>
            <select id="f-ciclo" onchange="onInput()">
              <option value="">Selecione...</option>
              <option value="curto">Curto â€” 1 a 7 dias</option>
              <option value="medio">MÃ©dio â€” 7 a 30 dias</option>
              <option value="longo">Longo â€” 30 a 90 dias</option>
              <option value="muito-longo">Muito longo â€” 90+ dias</option>
            </select>
          </div>
          <div class="field">
            <div class="field-label">Maturidade da marca</div>
            <select id="f-marca" onchange="onInput()">
              <option value="">Selecione...</option>
              <option value="consolidada">Consolidada â€” brand search relevante</option>
              <option value="crescimento">Em crescimento â€” awareness importante</option>
              <option value="nicho">Nicho / segmentada</option>
            </select>
          </div>
        </div>
      </div>

      <div class="card-section">
        <div class="card-section-label">ConversÃµes a modelar</div>
        <div class="chips" id="chips-conv">
          <div class="chip" onclick="chip(this)">Abertura de conta</div>
          <div class="chip on" onclick="chip(this)">GeraÃ§Ã£o de lead</div>
          <div class="chip" onclick="chip(this)">FinalizaÃ§Ã£o de compra</div>
          <div class="chip" onclick="chip(this)">InstalaÃ§Ã£o de app</div>
          <div class="chip" onclick="chip(this)">Contato com vendedor</div>
          <div class="chip" onclick="chip(this)">Cadastro / Registro</div>
        </div>
        <div class="chip-add-row">
          <input type="text" class="chip-add-input" id="add-conv" placeholder="Ex: Agendamento, SolicitaÃ§Ã£o de proposta..." onkeydown="if(event.key==='Enter')addChip('add-conv','chips-conv')">
          <button class="btn btn-ghost chip-add-btn" onclick="addChip('add-conv','chips-conv')">+ Adicionar</button>
        </div>
      </div>
    </div>

    <!-- MÃ­dia -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title">
            <div class="card-title-icon">ğŸ“¡</div>
            EstratÃ©gia de MÃ­dia e Dados
          </div>
          <div class="card-desc">ConfiguraÃ§Ã£o que gera automaticamente validaÃ§Ãµes, riscos e queries nas prÃ³ximas etapas</div>
        </div>
        <span class="badge badge-all">Todos</span>
      </div>

      <div class="card-section">
        <div class="card-section-label">Canais de mÃ­dia ativos</div>
        <div class="chips" id="chips-canal">
          <div class="chip on" onclick="chip(this)">Google Ads</div>
          <div class="chip on" onclick="chip(this)">Meta Ads</div>
          <div class="chip on" onclick="chip(this)">CRM / E-mail</div>
          <div class="chip" onclick="chip(this)">Display / ProgramÃ¡tico</div>
          <div class="chip" onclick="chip(this)">TikTok</div>
          <div class="chip" onclick="chip(this)">YouTube</div>
          <div class="chip" onclick="chip(this)">Afiliados</div>
          <div class="chip" onclick="chip(this)">Offline (TV / OOH)</div>
        </div>
        <div class="chip-add-row">
          <input type="text" class="chip-add-input" id="add-canal" placeholder="Ex: Pinterest, LinkedIn, SMS..." onkeydown="if(event.key==='Enter')addChip('add-canal','chips-canal')">
          <button class="btn btn-ghost chip-add-btn" onclick="addChip('add-canal','chips-canal')">+ Adicionar</button>
        </div>
      </div>

      <div class="card-section">
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Plataformas</div>
            <div class="chips" id="chips-plat">
              <div class="chip on" onclick="chip(this)">ğŸŒ Web</div>
              <div class="chip on" onclick="chip(this)">ğŸ“± App</div>
              <div class="chip" onclick="chip(this)">ğŸª FÃ­sico</div>
            </div>
            <div class="chip-add-row" style="margin-top:8px;">
              <input type="text" class="chip-add-input" id="add-plat" placeholder="Ex: Totem, Smartwatch..." onkeydown="if(event.key==='Enter')addChip('add-plat','chips-plat')">
              <button class="btn btn-ghost chip-add-btn" onclick="addChip('add-plat','chips-plat')">+</button>
            </div>
          </div>
          <div class="field">
            <div class="field-label">Ambiente logado?</div>
            <div class="chips" id="chips-login">
              <div class="chip on" onclick="chipExcl(this,'chips-login')">âœ“ Sim</div>
              <div class="chip" onclick="chipExcl(this,'chips-login')">NÃ£o / Parcial</div>
            </div>
          </div>
        </div>
        <div class="field-grid" style="margin-top:14px;">
          <div class="field">
            <div class="field-label">MMP ativo?</div>
            <div class="chips" id="chips-mmp">
              <div class="chip" onclick="chip(this)">Adjust</div>
              <div class="chip" onclick="chip(this)">AppsFlyer</div>
              <div class="chip on" onclick="chipExcl(this,'chips-mmp')">NÃ£o usa MMP</div>
            </div>
          </div>
          <div class="field">
            <div class="field-label">BigQuery configurado?</div>
            <div class="chips" id="chips-bq">
              <div class="chip on" onclick="chipExcl(this,'chips-bq')">âœ“ Sim</div>
              <div class="chip" onclick="chipExcl(this,'chips-bq')">NÃ£o / Em andamento</div>
            </div>
          </div>
        </div>
      </div>

      <div class="card-section">
        <div class="card-section-label">Perguntas do cliente <span class="badge badge-ba" style="margin-left:4px;">BA</span></div>
        <div id="q-list">
          <div class="q-row"><div class="q-num">1</div><input class="q-input" type="text" placeholder="O que o cliente quer descobrir?" oninput="onInput()"></div>
          <div class="q-row"><div class="q-num">2</div><input class="q-input" type="text" placeholder="Digite outra pergunta..." oninput="onInput()"></div>
          <div class="q-row"><div class="q-num">3</div><input class="q-input" type="text" value="O CRM estÃ¡ sendo canibalizado por mÃ­dia paga no last touch?" oninput="onInput()"></div>
        </div>
        <div style="padding:10px 16px;">
          <button class="btn btn-ghost" style="font-size:12px; padding:5px 12px;" onclick="addQ()">+ Pergunta</button>
        </div>
      </div>

      <div class="card-footer">ğŸ’¡ Cada canal e plataforma selecionada gera automaticamente validaÃ§Ãµes, riscos e queries para o DE nas prÃ³ximas etapas</div>
    </div>

    <!-- Actions -->
    <div class="stage-actions" style="border-radius: var(--r-lg);">
      <div class="actions-left">
        <span style="font-size:12px; color:var(--text-3);" id="ft1-msg">Preencha cliente e objetivo para avanÃ§ar</span>
      </div>
      <button class="btn btn-primary" onclick="goTo(2)">AvanÃ§ar para Mapeamento â†’</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar-right">

    <div class="lw-card" id="lw-card">
      <div class="lw-label">â± Lookback Sugerida</div>
      <div>
        <span class="lw-val" id="lw-val">â€”</span>
        <span class="lw-unit" id="lw-unit"></span>
      </div>
      <div class="lw-sub" id="lw-sub">Selecione o ciclo de decisÃ£o</div>
      <div class="lw-range hidden" id="lw-range"></div>
      <div class="lw-de-note hidden" id="lw-note">ğŸ”§ DE: extraia dados com essa janela extra antes do perÃ­odo de anÃ¡lise</div>
    </div>

    <div class="mini-grid">
      <div class="mini-card">
        <div class="mini-val blue" id="sum-canais">3</div>
        <div class="mini-label">canais ativos</div>
      </div>
      <div class="mini-card">
        <div class="mini-val green" id="sum-conv">1</div>
        <div class="mini-label">conversÃ£o(Ãµes)</div>
      </div>
      <div class="mini-card">
        <div class="mini-val warn" id="sum-riscos">0</div>
        <div class="mini-label">riscos detectados</div>
      </div>
      <div class="mini-card">
        <div class="mini-val" id="sum-plat">2</div>
        <div class="mini-label">plataformas</div>
      </div>
    </div>

    <div class="alerts-stack" id="alerts-1"></div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ETAPA 2 â€” MAPEAMENTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-view" id="view-2">
<div class="page-layout">

  <div class="stack">
    <div class="stage-header">
      <div class="stage-icon-wrap" style="background: var(--de);">ğŸ—„ï¸</div>
      <div>
        <div class="stage-h-title">Mapeamento e Entendimento</div>
        <div class="stage-h-desc">ValidaÃ§Ãµes e riscos gerados automaticamente com base na configuraÃ§Ã£o da Etapa 1</div>
        <span class="auto-pill">âœ¨ Gerado automaticamente</span>
      </div>
    </div>

    <!-- Checklist maturidade -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--de-bg);">âœ…</div>ValidaÃ§Ãµes de Maturidade de Dados</div>
          <div class="card-desc">Itens marcados com âœ¨ foram gerados com base nos canais e plataformas selecionados</div>
        </div>
        <span class="badge badge-de">DE</span>
      </div>
      <div class="checklist" id="e2-checklist"></div>
    </div>

    <!-- Riscos -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--danger-bg);">âš ï¸</div>Pontos Cegos e Riscos Identificados</div>
          <div class="card-desc">Clique em cada risco para ver o impacto e a aÃ§Ã£o recomendada</div>
        </div>
        <span class="badge badge-auto">âœ¨ AUTO</span>
      </div>
      <div style="padding:14px 16px;" id="e2-risks"></div>
    </div>

    <div class="stage-actions" style="border-radius: var(--r-lg);">
      <button class="btn btn-ghost" onclick="goTo(1)">â† Voltar</button>
      <button class="btn btn-primary" onclick="goTo(3)">AvanÃ§ar para DiagnÃ³stico â†’</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar-right">
    <!-- DE panel -->
    <div class="de-panel">
      <div class="card">
        <div class="card-head" style="background:var(--de-bg); border-color:var(--de-border);">
          <div>
            <div class="card-title" style="color:var(--de);">ğŸ”§ Queries DE</div>
            <div class="card-desc" style="color:var(--de); opacity:.7;">Geradas automaticamente</div>
          </div>
          <span class="badge badge-de">DE</span>
        </div>
        <div id="e2-queries"></div>
      </div>
    </div>
    <div class="ds-panel">
      <div class="alert alert-info fade-up">
        <div class="alert-title">ğŸ“ Foco DS nesta etapa</div>
        <div class="alert-body">Aguarde a base ser validada pelo DE. Revise os riscos identificados â€” eles impactam a EDA. Alinhe o agrupamento de canais antes de planejar os modelos.</div>
      </div>
    </div>
    <div class="ba-panel">
      <div class="alert alert-info fade-up">
        <div class="alert-title">ğŸ“Š Foco BA nesta etapa</div>
        <div class="alert-body">Comunique as limitaÃ§Ãµes ao cliente agora. Isso evita surpresas na apresentaÃ§Ã£o final. Documente as perguntas de negÃ³cio que cada risco pode comprometer.</div>
      </div>
    </div>
    <div class="alerts-stack" id="alerts-2"></div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ETAPA 3 â€” DIAGNÃ“STICO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-view" id="view-3">
<div class="page-layout">

  <div class="stack">
    <div class="stage-header">
      <div class="stage-icon-wrap" style="background: var(--ds);">ğŸ§ </div>
      <div>
        <div class="stage-h-title">DiagnÃ³stico e Planejamento</div>
        <div class="stage-h-desc">ConversÃ£o, agrupamento de canais, lookback e perguntas da EDA â€” prÃ©-populados da Etapa 1</div>
        <span class="auto-pill">âœ¨ PrÃ©-populado automaticamente</span>
      </div>
    </div>

    <!-- ConversÃ£o -->
    <div class="card">
      <div class="card-head">
        <div class="card-title"><div class="card-title-icon">ğŸ¯</div>DefiniÃ§Ã£o de ConversÃ£o</div>
        <span class="badge badge-all">Todos</span>
      </div>
      <div class="card-section">
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Evento no GA4 / BigQuery <span class="req">*</span></div>
            <input type="text" id="f-conv-evt" placeholder="Ex: generate_lead, purchase">
          </div>
          <div class="field">
            <div class="field-label">Escopo</div>
            <div class="chips">
              <div class="chip on" onclick="chipExcl(this, null)">1a conversÃ£o por usuÃ¡rio</div>
              <div class="chip" onclick="chipExcl(this, null)">Todas as conversÃµes</div>
            </div>
          </div>
        </div>
        <div style="margin-top:12px;" id="e3-conv-alert"></div>
      </div>
    </div>

    <!-- Canal table -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title"><div class="card-title-icon">ğŸ“Š</div>Agrupamento de Canais</div>
          <div class="card-desc">PrÃ©-populado com base nos canais ativos da Etapa 1 â€” revise com o cliente antes de construir a base</div>
        </div>
        <span class="badge badge-auto">âœ¨ AUTO</span>
      </div>
      <div style="padding:14px 16px;">
        <div class="alert alert-de" style="margin-bottom:12px;">
          <div class="alert-title">ğŸ”§ DE: use esta tabela no CASE WHEN da query de agrupamento de canais</div>
          <div class="alert-body">Valide cada grupo com o cliente e com o BA antes de construir a base. A granularidade aqui define o que serÃ¡ possÃ­vel descobrir.</div>
        </div>
        <table class="ch-table" id="e3-ch-table"></table>
      </div>
    </div>

    <!-- Lookback -->
    <div class="card">
      <div class="card-head">
        <div class="card-title"><div class="card-title-icon">ğŸ•</div>Lookback Window e PerÃ­odos</div>
        <span class="badge badge-auto">âœ¨ Sugerida</span>
      </div>
      <div class="card-section">
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Lookback window (dias)</div>
            <input type="text" id="f-lw-input" placeholder="Ex: 30">
            <div style="font-size:11px; color:var(--de); margin-top:4px; font-weight:600;" id="e3-lw-hint"></div>
          </div>
          <div class="field">
            <div class="field-label">PerÃ­odo de anÃ¡lise</div>
            <div style="display:flex; gap:6px;">
              <input type="text" placeholder="InÃ­cio: 01/01/2025">
              <input type="text" placeholder="Fim: 31/03/2025">
            </div>
          </div>
        </div>
        <div style="margin-top:12px;">
          <div class="field-label" style="margin-bottom:6px;">PerÃ­odo mÃ­nimo de extraÃ§Ã£o (BigQuery)</div>
          <div style="font-family:'JetBrains Mono',monospace; font-size:11px; background:var(--navy); color:#7DD3FC; padding:9px 12px; border-radius:6px;" id="e3-bq-range">inÃ­cio - <span id="lw-days-e3">?</span> dias â†’ fim do perÃ­odo</div>
        </div>
      </div>
    </div>

    <!-- EDA -->
    <div class="card">
      <div class="card-head">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--ds-bg);">ğŸ”</div>Perguntas da EDA</div>
          <div class="card-desc">Geradas com base no objetivo e configuraÃ§Ã£o do projeto</div>
        </div>
        <span class="badge badge-auto">âœ¨ AUTO</span>
      </div>
      <div class="checklist" id="e3-eda"></div>
      <div class="card-footer">ğŸ“ DS: essas perguntas vÃ£o para o notebook. BA: valide que cobrem as perguntas do cliente da Etapa 1.</div>
    </div>

    <!-- Modelo -->
    <div class="card">
      <div class="card-head">
        <div class="card-title"><div class="card-title-icon" style="background:var(--ds-bg);">ğŸ¤–</div>Modelo de AtribuiÃ§Ã£o</div>
        <span class="badge badge-ds">DS</span>
      </div>
      <div class="card-section">
        <div id="e3-model-rec" style="margin-bottom:12px;"></div>
        <div class="model-opt selected" onclick="selModel(this)">
          <div class="model-opt-top">
            <span class="model-name">ğŸ“ Markov Chain</span>
            <span class="model-rec" id="markov-rec-badge">RECOMENDADO</span>
          </div>
          <div class="model-desc">Considera jornadas nÃ£o conversoras. Gera efeito de remoÃ§Ã£o e matriz de transiÃ§Ã£o entre canais. Ideal para anÃ¡lise de canibalizaÃ§Ã£o.</div>
        </div>
        <div class="model-opt" onclick="selModel(this)">
          <div class="model-opt-top"><span class="model-name">ğŸ® Shapley Value</span></div>
          <div class="model-desc">DistribuiÃ§Ã£o justa de crÃ©dito por contribuiÃ§Ã£o marginal de cada canal. Mais intenso computacionalmente.</div>
        </div>
        <div class="model-opt" onclick="selModel(this)">
          <div class="model-opt-top"><span class="model-name">ğŸ“ + ğŸ® ComparaÃ§Ã£o Markov vs. Shapley</span></div>
          <div class="model-desc">Recomendado quando hÃ¡ dÃºvida sobre qual modelo reflete melhor a realidade do negÃ³cio do cliente.</div>
        </div>
        <div class="model-opt" onclick="selModel(this)">
          <div class="model-opt-top"><span class="model-name">ğŸ” Apenas EDA</span></div>
          <div class="model-desc">GA jÃ¡ responde as perguntas, ou o objetivo Ã© puramente exploratÃ³rio â€” sem modelagem de atribuiÃ§Ã£o.</div>
        </div>
      </div>
    </div>

    <div class="stage-actions" style="border-radius: var(--r-lg);">
      <button class="btn btn-ghost" onclick="goTo(2)">â† Voltar</button>
      <button class="btn btn-primary" onclick="goTo(4)">AvanÃ§ar para ConstruÃ§Ã£o â†’</button>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar-right">
    <div class="alerts-stack" id="alerts-3"></div>
    <div class="de-panel">
      <div class="query-block">
        <div class="query-head">
          <div class="query-head-info">
            <div class="query-name">Query: Agrupamento de Canais</div>
            <div class="query-desc">CASE WHEN para categorizar sessÃµes</div>
          </div>
        </div>
        <div class="query-code"><span class="cm">-- Agrupamento de canais na base</span>
<span class="kw">SELECT</span> session_id,
  <span class="kw">CASE</span>
    <span class="kw">WHEN</span> medium = <span class="str">'cpc'</span>        <span class="kw">THEN</span> <span class="str">'MÃ­dia Performance'</span>
    <span class="kw">WHEN</span> medium = <span class="str">'display'</span>    <span class="kw">THEN</span> <span class="str">'MÃ­dia Awareness'</span>
    <span class="kw">WHEN</span> medium = <span class="str">'email'</span>      <span class="kw">THEN</span> <span class="str">'CRM'</span>
    <span class="kw">WHEN</span> medium = <span class="str">'organic'</span>    <span class="kw">THEN</span> <span class="str">'OrgÃ¢nico'</span>
    <span class="kw">WHEN</span> source = <span class="str">'(direct)'</span>  <span class="kw">THEN</span> <span class="str">'Direto'</span>
    <span class="kw">ELSE</span>                         <span class="str">'Outros'</span>
  <span class="kw">END</span> <span class="kw">AS</span> canal_agrupado
<span class="kw">FROM</span> sessions_base</div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ETAPA 4 â€” CONSTRUÃ‡ÃƒO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="stage-view" id="view-4">
<div class="page-layout">

  <div class="stack">
    <div class="stage-header">
      <div class="stage-icon-wrap" style="background: linear-gradient(135deg,var(--ba),#059669);">ğŸ—ï¸</div>
      <div>
        <div class="stage-h-title">ConstruÃ§Ã£o</div>
        <div class="stage-h-desc">Tarefas geradas por Ã¡rea (DE / DS / BA) com base em tudo que foi configurado</div>
        <span class="auto-pill">âœ¨ Tarefas geradas automaticamente</span>
      </div>
    </div>

    <!-- DE -->
    <div class="card">
      <div class="card-head" style="border-left: 4px solid var(--de);">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--de-bg);">ğŸ”§</div>Base de Jornada</div>
          <div class="card-desc">Tarefas do DE â€” construÃ§Ã£o, validaÃ§Ã£o e entrega da base</div>
        </div>
        <span class="badge badge-de">DE</span>
      </div>
      <div class="checklist" id="e4-de"></div>
      <div class="card-footer">âš ï¸ NÃ£o passe a base para o DS sem validar o volume e o User ID cross-platform. RefatoraÃ§Ã£o posterior Ã© muito custosa.</div>
    </div>

    <!-- DS -->
    <div class="card">
      <div class="card-head" style="border-left: 4px solid var(--ds);">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--ds-bg);">ğŸ¤–</div>EDA e Modelo</div>
          <div class="card-desc">Tarefas do DS â€” anÃ¡lise exploratÃ³ria e execuÃ§Ã£o do modelo</div>
        </div>
        <span class="badge badge-ds">DS</span>
      </div>
      <div class="checklist" id="e4-ds"></div>
    </div>

    <!-- BA -->
    <div class="card">
      <div class="card-head" style="border-left: 4px solid var(--ba);">
        <div>
          <div class="card-title"><div class="card-title-icon" style="background:var(--ba-bg);">ğŸ“Š</div>Insights e ApresentaÃ§Ã£o</div>
          <div class="card-desc">Tarefas do BA â€” storytelling, resposta Ã s perguntas do cliente e entrega</div>
        </div>
        <span class="badge badge-ba">BA</span>
      </div>
      <div class="checklist" id="e4-ba"></div>
    </div>

    <div class="stage-actions" style="border-radius: var(--r-lg);">
      <button class="btn btn-ghost" onclick="goTo(3)">â† Voltar</button>
      <div class="progress-wrap">
        <div class="progress-track">
          <div class="progress-fill" id="e4-bar" style="width:0%"></div>
        </div>
        <span class="progress-label" id="e4-pct">0% concluÃ­do</span>
      </div>
    </div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar-right">
    <div class="de-panel">
      <div class="query-block">
        <div class="query-head">
          <div class="query-head-info">
            <div class="query-name">Base de Jornadas</div>
            <div class="query-desc">Eventos â†’ uma linha por jornada</div>
          </div>
        </div>
        <div class="query-code"><span class="cm">-- Montar base de jornadas</span>
<span class="kw">SELECT</span>
  user_id,
  <span class="fn">STRING_AGG</span>(
    canal_agrupado,
    <span class="str">' > '</span>
    <span class="kw">ORDER BY</span> event_timestamp
  ) <span class="kw">AS</span> jornada,
  <span class="fn">MAX</span>(is_conversion) <span class="kw">AS</span> converteu,
  <span class="fn">COUNT</span>(*) <span class="kw">AS</span> touchpoints,
  <span class="fn">DATE_DIFF</span>(
    <span class="fn">MAX</span>(event_date),
    <span class="fn">MIN</span>(event_date),
    <span class="kw">DAY</span>
  ) <span class="kw">AS</span> duracao_dias
<span class="kw">FROM</span> sessions_agrupadas
<span class="kw">WHERE</span> event_date <span class="kw">BETWEEN</span>
  <span class="str">'DATA_INICIO'</span> <span class="kw">AND</span> <span class="str">'DATA_FIM'</span>
<span class="kw">GROUP BY</span> user_id</div>
      </div>
    </div>
    <div class="alerts-stack" id="alerts-4"></div>
  </div>

</div>
</div>

<script>
// ===============================================
// STATE
// ===============================================
const S = { role: 'de', stage: 1 };

const LW_MAP = {
  curto:       { days: 14,  label: '14 dias',  hint: 'Ciclo curto -> 7-14 dias. Valide na EDA.' },
  medio:       { days: 30,  label: '30 dias',  hint: 'Ciclo mÃ©dio -> 30 dias recomendados. Valide na EDA.' },
  longo:       { days: 60,  label: '60 dias',  hint: 'Ciclo longo -> 60 dias. Valide na EDA se 90% das jornadas fecham antes.' },
  'muito-longo':{ days: 90, label: '90 dias',  hint: 'Ciclo muito longo -> 90 dias ou mais. Valide empiricamente.' }
};

// ===============================================
// NAVIGATION
// ===============================================
function goTo(n) {
  document.querySelectorAll('.stage-view').forEach(v => v.classList.remove('sv-active'));
  document.getElementById('view-' + n).classList.add('sv-active');

  for (let i = 1; i <= 4; i++) {
    const ss = document.getElementById('ss-' + i);
    const sb = document.getElementById('sb-' + i);
    ss.classList.remove('ss-active','ss-done');
    if (i < n) { ss.classList.add('ss-done'); sb.textContent = 'v'; }
    else { sb.textContent = i; }
    if (i === n) ss.classList.add('ss-active');
  }
  S.stage = n;
  if (n === 2) buildStage2();
  if (n === 3) buildStage3();
  if (n === 4) buildStage4();
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// ===============================================
// ROLE
// ===============================================
function setRole(r) {
  S.role = r;
  document.body.setAttribute('data-role', r);
  ['de','ds','ba'].forEach(x => {
    const b = document.getElementById('rb-' + x);
    b.className = 'role-btn r' + x + (x === r ? ' r-active' : '');
  });
}

// ===============================================
// CHIPS
// ===============================================
function chip(el) { el.classList.toggle('on'); onInput(); }
function chipExcl(el, groupId) {
  const g = groupId ? document.getElementById(groupId) : el.closest('.chips');
  if (g) g.querySelectorAll('.chip').forEach(c => c.classList.remove('on'));
  el.classList.add('on');
  onInput();
}

// ===============================================
// HELPERS
// ===============================================
function chipsOn(id) {
  return [...document.querySelectorAll('#' + id + ' .chip.on')].map(c => c.textContent.trim());
}
function v(id) { const el = document.getElementById(id); return el ? el.value.trim() : ''; }
function hasChip(id, str) { return chipsOn(id).some(c => c.toLowerCase().includes(str.toLowerCase())); }

// ===============================================
// LOOKBACK
// ===============================================
function updateLookback() {
  const ciclo = v('f-ciclo');
  const lw = LW_MAP[ciclo];
  const valEl = document.getElementById('lw-val');
  const unitEl = document.getElementById('lw-unit');
  const subEl = document.getElementById('lw-sub');
  const rangeEl = document.getElementById('lw-range');
  const noteEl = document.getElementById('lw-note');

  if (lw) {
    valEl.textContent = lw.days;
    unitEl.textContent = 'dias';
    subEl.textContent = lw.label + ' recomendados';
    rangeEl.textContent = 'ğŸ”§ DE: inÃ­cio do perÃ­odo - ' + lw.days + ' dias';
    rangeEl.classList.remove('hidden');
    noteEl.classList.remove('hidden');
    const fi = document.getElementById('f-lw-input');
    if (fi) fi.value = lw.days;
    const dd = document.getElementById('lw-days-e3');
    if (dd) dd.textContent = lw.days;
    const h = document.getElementById('e3-lw-hint');
    if (h) h.textContent = 'ğŸ’¡ ' + lw.hint;
  } else {
    valEl.textContent = ' -- ';
    unitEl.textContent = '';
    subEl.textContent = 'Selecione o ciclo de decisÃ£o';
    rangeEl.classList.add('hidden');
    noteEl.classList.add('hidden');
  }
}

// ===============================================
// ALERTS (gerados dinamicamente)
// ===============================================
function buildAlerts() {
  const obj = v('f-obj');
  const marca = v('f-marca');
  const ciclo = v('f-ciclo');
  const hasApp = hasChip('chips-plat','app');
  const hasWeb = hasChip('chips-plat','web');
  const hasCRM = hasChip('chips-canal','crm');
  const hasOffline = hasChip('chips-canal','offline');
  const hasMMP = hasChip('chips-mmp','adjust') || hasChip('chips-mmp','appsflyer');

  const alerts = [];
  if (obj === 'canib') alerts.push({ type: 'info', t: 'Objetivo: CanibalizaÃ§Ã£o -> Markov recomendado', b: 'DS: a comparaÃ§Ã£o Last Click vs. Markov com efeito de remoÃ§Ã£o responde diretamente o que o cliente quer. Planeje isso desde jÃ¡.' });
  if (obj === 'awareness') alerts.push({ type: 'warn', t: 'Awareness -> lookback provavelmente maior', b: 'Para capturar impacto de canais de awareness, a lookback tende a precisar de 60-90 dias. Valide na EDA.' });
  if (marca === 'consolidada') alerts.push({ type: 'warn', t: 'Marca consolidada -> risco de brand search', b: 'Brand search tende a aparecer como last touch em marcas conhecidas  --  pode ser interpretado como canibalizaÃ§Ã£o. Discuta com o cliente antes da EDA.' });
  if (hasApp && hasWeb) alerts.push({ type: 'danger', t: '(!) App + Web -> User ID cross-platform crÃ­tico', b: 'DE: valide se o mesmo User ID persiste entre as duas plataformas. Sem isso, o mesmo usuÃ¡rio Ã© contado duas vezes na jornada.' });
  if (hasCRM) alerts.push({ type: 'info', t: 'CRM ativo -> mapear identificador de usuÃ¡rio', b: 'DE: confirme como o CRM identifica o usuÃ¡rio e se Ã© cruzÃ¡vel com o GA4 antes de montar a base.' });
  if (hasOffline) alerts.push({ type: 'warn', t: 'Canal offline -> identificador necessÃ¡rio', b: 'ConversÃµes offline sÃ³ entram no MTA se houver um identificador de usuÃ¡rio cruzÃ¡vel. Mapeie com o cliente.' });

  const riscos = alerts.filter(a => a.type === 'danger' || a.type === 'warn').length;
  const el = document.getElementById('sum-riscos');
  if (el) el.textContent = riscos;

  const alertHtml = a => `<div class="alert alert-${a.type === 'danger' ? 'danger' : a.type === 'warn' ? 'warn' : 'info'} fade-up"><div class="alert-title">${a.t}</div><div class="alert-body">${a.b}</div></div>`;
  ['1','2','3','4'].forEach(n => {
    const el = document.getElementById('alerts-' + n);
    if (el) el.innerHTML = alerts.map(alertHtml).join('');
  });

  // Model rec
  const recEl = document.getElementById('e3-model-rec');
  const markovBadge = document.getElementById('markov-rec-badge');
  if (recEl) {
    if (obj === 'canib') {
      recEl.innerHTML = `<div class="alert alert-info"><div class="alert-title">ğŸ’¡ DS: Markov Chain recomendado</div><div class="alert-body">O efeito de remoÃ§Ã£o e a matriz de transiÃ§Ã£o respondem diretamente o objetivo de canibalizaÃ§Ã£o definido pelo cliente.</div></div>`;
      if (markovBadge) markovBadge.style.display = 'inline-flex';
    } else if (obj === 'awareness') {
      recEl.innerHTML = `<div class="alert alert-info"><div class="alert-title">ğŸ’¡ DS: EDA pode ser suficiente</div><div class="alert-body">Para awareness, a anÃ¡lise exploratÃ³ria da posiÃ§Ã£o dos canais na jornada pode responder as perguntas sem modelagem completa.</div></div>`;
      if (markovBadge) markovBadge.style.display = 'none';
    } else { recEl.innerHTML = ''; if (markovBadge) markovBadge.style.display = 'inline-flex'; }
  }
}

// ===============================================
// SUMMARY
// ===============================================
function updateSummary() {
  const canais = chipsOn('chips-canal').length;
  const conv = chipsOn('chips-conv').length;
  const plat = chipsOn('chips-plat').length;
  const c = v('f-cliente');

  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  set('sum-canais', canais);
  set('sum-conv', conv || 1);
  set('sum-plat', plat || 1);

  const hp = document.getElementById('hdr-project');
  if (hp) hp.textContent = c ? 'ğŸ“‹ ' + c : 'ğŸ“‹ Novo Projeto';
}

// ===============================================
// MAIN INPUT HANDLER
// ===============================================
function onInput() {
  updateLookback();
  updateSummary();
  buildAlerts();
}

// ===============================================
// BUILD STAGE 2
// ===============================================
function buildStage2() {
  const hasApp = hasChip('chips-plat','app');
  const hasWeb = hasChip('chips-plat','web');
  const hasCRM = hasChip('chips-canal','crm');
  const hasMMP = hasChip('chips-mmp','adjust') || hasChip('chips-mmp','appsflyer');
  const hasOffline = hasChip('chips-canal','offline');
  const bqOk = hasChip('chips-bq','sim');

  const checks = [
    { t: 'GA4 -> BigQuery export ativo e configurado', auto: true, role:'de', reason:'Fonte primÃ¡ria obrigatÃ³ria para MTA' },
    hasApp && hasWeb ? { t: 'User ID persistindo entre web e app (Golden ID / cross-platform)', auto: true, role:'de', reason:'App + Web detectado', crit: true } : null,
    hasCRM ? { t: 'Dados de CRM disponÃ­veis com User ID cruzÃ¡vel com o GA4', auto: true, role:'de', reason:'CRM Ã© canal ativo' } : null,
    hasMMP ? { t: 'ExportaÃ§Ã£o dos dados de MMP para BigQuery / GCP configurada', auto: true, role:'de', reason:'MMP ativo  --  dados de app precisam ser cruzados', crit: true } : null,
    hasOffline ? { t: 'Dados offline mapeados com identificador de usuÃ¡rio cruzÃ¡vel', auto: true, role:'de', reason:'Canal offline detectado', crit: true } : null,
    { t: 'UTMs padronizados e consistentes (source, medium, campaign)', auto: false },
    { t: 'HistÃ³rico suficiente: mÃ­n. 3 meses de dados de boa qualidade', auto: false },
    { t: 'Acessos e permissÃµes ao BigQuery confirmados para o time', auto: false },
    { t: 'Volume estimado validado (sessÃµes/mÃªs no perÃ­odo de anÃ¡lise)', auto: false },
    hasApp ? { t: '(!) Testado na prÃ¡tica: usuÃ¡rio logado no app e web Ã© unificado corretamente', auto: true, role:'de', reason:'Etapa crÃ­tica antes de construir qualquer base', crit: true } : null,
  ].filter(Boolean);

  const cl = document.getElementById('e2-checklist');
  cl.innerHTML = checks.map((c, i) => `
    <div class="check-row${c.auto ? (c.crit ? ' auto-de crit' : ' auto-de') : ''}" onclick="toggleCheck(this)">
      <div class="chkbox">v</div>
      <div style="flex:1;">
        <div class="check-text">${c.t}</div>
        ${c.auto ? `<div class="check-meta"><span class="badge badge-auto">* AUTO</span> ${c.reason}${c.crit ? ' <span class="badge" style="background:var(--danger);color:#fff;border:none;font-size:9px;">CRÃTICO</span>' : ''}</div>` : ''}
      </div>
    </div>`).join('');

  // Risks
  const risks = [
    hasApp && hasWeb ? { lv:'high', t:'User ID nÃ£o unificado entre web e app', d:'O mesmo usuÃ¡rio serÃ¡ contado como duas pessoas distintas  --  a jornada ficarÃ¡ fragmentada e os resultados, incorretos.', a:'-> DE: rodar query de validaÃ§Ã£o de User ID cross-platform antes de construir qualquer base' } : null,
    hasApp ? { lv:'high', t:'Quebra de sessÃ£o via deep link / Unilink para app', d:'Cliques em anÃºncios que abrem o app via link direto podem quebrar a sessÃ£o e perder o touchpoint de origem da mÃ­dia.', a:'-> DE: implementar parÃ¢metro de rastreamento no deep link conforme documentaÃ§Ã£o tÃ©cnica' } : null,
    hasCRM ? { lv:'med', t:'CRM sem identificador cruzÃ¡vel com GA4', d:'Se o CRM nÃ£o usar o mesmo User ID do GA4, os disparos de e-mail e push nÃ£o aparecerÃ£o corretamente na jornada do usuÃ¡rio.', a:'-> BA + DE: mapear como o CRM identifica o usuÃ¡rio e definir estratÃ©gia de cruzamento' } : null,
    !bqOk ? { lv:'high', t:'BigQuery nÃ£o configurado  --  MTA inviÃ¡vel', d:'A exportaÃ§Ã£o do GA4 para BigQuery Ã© condiÃ§Ã£o bÃ¡sica para qualquer projeto de MTA customizado. Sem isso, o projeto nÃ£o avanÃ§a.', a:'-> DE + cliente: priorizar configuraÃ§Ã£o do BigQuery export imediatamente' } : null,
    hasMMP ? { lv:'med', t:'Dados de MMP em plataforma separada', d:'Dados de Adjust/AppsFlyer precisam ser exportados para o GCP e integrados ao BigQuery para compor a jornada do usuÃ¡rio em app.', a:'-> DE: planejar exportaÃ§Ã£o e base unificada MMP + GA4 com ID Ãºnico' } : null,
    hasOffline ? { lv:'med', t:'Canal offline sem identificador confirmado', d:'Para incluir conversÃµes offline no MTA Ã© necessÃ¡rio um identificador de usuÃ¡rio cruzÃ¡vel. Sem isso, os dados offline ficam fora da jornada.', a:'-> BA + cliente: confirmar se hÃ¡ ID de usuÃ¡rio para cruzamento com o ambiente digital' } : null,
  ].filter(Boolean);

  const rp = document.getElementById('e2-risks');
  rp.innerHTML = risks.map((r, i) => `
    <div class="risk-card">
      <div class="risk-head" onclick="toggleRisk(this)">
        <span class="risk-level ${r.lv === 'high' ? 'rl-high' : 'rl-med'}">${r.lv === 'high' ? 'ALTO' : 'MÃ‰DIO'}</span>
        <span class="risk-title">${r.t}</span>
        <span class="risk-chevron">v</span>
      </div>
      <div class="risk-body">
        ${r.d}
        <div class="risk-action">${r.a}</div>
      </div>
    </div>`).join('');

  // Queries for DE
  const queries = [];
  if (hasApp && hasWeb) queries.push({
    name: 'ValidaÃ§Ã£o User ID cross-platform',
    desc: 'User IDs que aparecem em web E app',
    code: `<span class="cm">-- User IDs presentes em web E app</span>\n<span class="kw">SELECT</span>\n  user_id,\n  <span class="fn">COUNT</span>(<span class="kw">DISTINCT</span> platform) <span class="kw">AS</span> plataformas,\n  <span class="fn">ARRAY_AGG</span>(<span class="kw">DISTINCT</span> platform) <span class="kw">AS</span> lista\n<span class="kw">FROM</span> <span class="str">\`proj.dataset.events_*\`</span>\n<span class="kw">WHERE</span> user_id <span class="kw">IS NOT NULL</span>\n<span class="kw">GROUP BY</span> user_id\n<span class="kw">HAVING</span> plataformas > <span class="num">1</span>\n<span class="kw">LIMIT</span> <span class="num">200</span>`
  });
  queries.push({
    name: 'Cobertura de UTMs',
    desc: '% sessÃµes com e sem UTM por source/medium',
    code: `<span class="cm">-- DiagnÃ³stico de cobertura UTM</span>\n<span class="kw">SELECT</span>\n  traffic_source.source,\n  traffic_source.medium,\n  <span class="fn">COUNT</span>(*) <span class="kw">AS</span> sessoes,\n  <span class="fn">ROUND</span>(<span class="fn">COUNT</span>(*) * <span class="num">100.0</span> /\n    <span class="fn">SUM</span>(<span class="fn">COUNT</span>(*)) <span class="kw">OVER</span>(), <span class="num">2</span>) <span class="kw">AS</span> pct\n<span class="kw">FROM</span> <span class="str">\`proj.dataset.events_*\`</span>\n<span class="kw">WHERE</span> _TABLE_SUFFIX <span class="kw">BETWEEN</span>\n  <span class="str">'20250101'</span> <span class="kw">AND</span> <span class="str">'20250331'</span>\n<span class="kw">GROUP BY</span> <span class="num">1</span>, <span class="num">2</span>\n<span class="kw">ORDER BY</span> sessoes <span class="kw">DESC</span>`
  });

  const qc = document.getElementById('e2-queries');
  qc.innerHTML = queries.map(q => `
    <div style="border-bottom:1px solid var(--de-border);">
      <div class="query-head">
        <div class="query-head-info">
          <div class="query-name">${q.name}</div>
          <div class="query-desc">${q.desc}</div>
        </div>
      </div>
      <div class="query-code">${q.code}</div>
    </div>`).join('');
}

// ===============================================
// BUILD STAGE 3
// ===============================================
function buildStage3() {
  const canal = chipsOn('chips-canal');
  const plat = chipsOn('chips-plat');
  const obj = v('f-obj');
  const lw = document.getElementById('lw-val')?.textContent || '?';

  // Canal table
  const rows = [
    { name:'Direto', crit:'(direct) / (none)', ex:'direct / none' },
    { name:'OrgÃ¢nico', crit:'organic', ex:'google / organic' },
  ];
  if (canal.some(c=>c.includes('Google'))) rows.push({ name:'MÃ­dia Performance', crit:'cpc, paid_search', ex:'google / cpc' });
  if (canal.some(c=>c.includes('Meta'))) rows.push({ name:'MÃ­dia Social Paga', crit:'paid_social, cpm', ex:'meta / paid_social' });
  if (canal.some(c=>c.includes('YouTube')||c.includes('Display'))) rows.push({ name:'MÃ­dia Awareness', crit:'display, video, awareness', ex:'youtube / video' });
  if (canal.some(c=>c.includes('CRM'))) { rows.push({ name:'CRM Transacional', crit:'email / transacional', ex:'crm / transacional' }); rows.push({ name:'CRM Promocional', crit:'email / promocional, push', ex:'crm / push' }); }
  if (canal.some(c=>c.includes('Afiliados'))) rows.push({ name:'Afiliados', crit:'affiliate, referral', ex:'afiliados / referral' });
  rows.push({ name:'NÃ£o identificado', crit:'sem UTM vÃ¡lido', ex:'Unassigned' });

  const tbl = document.getElementById('e3-ch-table');
  tbl.innerHTML = `<thead><tr><th>Canal Agrupado</th><th>CritÃ©rio (medium / source)</th><th>Exemplos</th></tr></thead><tbody>` +
    rows.map((r,i) => `<tr><td class="ch-name">${r.name}</td><td class="ch-code">${r.crit}</td><td style="color:var(--text-3);font-size:11px;">${r.ex}</td></tr>`).join('') + `</tbody>`;

  // EDA questions
  const edaQ = [
    { t: 'Qual o tempo mÃ©dio e no de touchpoints atÃ© a conversÃ£o?', auto: false },
    { t: 'Qual a % de jornadas com 1, 2, 3 ou mais touchpoints?', auto: false },
    { t: 'Quais canais aparecem mais em jornadas conversoras vs. nÃ£o conversoras?', auto: false },
    { t: 'Qual o papel de cada canal  --  Introdutor / Engajador / Conversor?', auto: false },
  ];
  const hasApp = hasChip('chips-plat','app');
  const hasWeb = hasChip('chips-plat','web');
  if (hasApp && hasWeb) edaQ.push({ t: 'Como se distribui a jornada entre web e app? HÃ¡ diferenÃ§a de conversÃ£o entre plataformas?', auto: true, role:'ds', reason:'Web + App ativos' });
  if (hasChip('chips-canal','crm')) edaQ.push({ t: 'O CRM aparece como Conversor ou como Engajador? HÃ¡ canibalizaÃ§Ã£o com mÃ­dia paga?', auto: true, role:'ds', reason:'CRM Ã© canal ativo' });
  if (obj === 'canib') edaQ.push({ t: 'HÃ¡ canibalizaÃ§Ã£o entre brand search e performance paga? Brand search aparece como last touch com que frequÃªncia?', auto: true, role:'ds', reason:'Objetivo: canibalizaÃ§Ã£o' });
  if (obj === 'awareness') edaQ.push({ t: 'Os canais de awareness aparecem no inÃ­cio da jornada? Com que frequÃªncia contribuem para conversÃµes futuras?', auto: true, role:'ds', reason:'Objetivo: justificar awareness' });
  edaQ.push({ t: `Qual a % de jornadas encerradas dentro de ${lw} dias? (calibragem da lookback window)`, auto: false });
  edaQ.push({ t: 'Como o comportamento dos canais difere entre os dois perÃ­odos analisados?', auto: false });

  const edaEl = document.getElementById('e3-eda');
  edaEl.innerHTML = edaQ.map((q, i) => `
    <div class="check-row${q.auto ? ' auto-' + (q.role||'ds') : ''}" onclick="toggleCheck(this)">
      <div class="chkbox">v</div>
      <div style="flex:1;">
        <div class="check-text">${q.t}</div>
        ${q.auto ? `<div class="check-meta"><span class="badge badge-auto">* AUTO</span> ${q.reason}</div>` : ''}
      </div>
    </div>`).join('');

  buildAlerts();
}

// ===============================================
// BUILD STAGE 4
// ===============================================
function buildStage4() {
  const hasApp = hasChip('chips-plat','app');
  const hasWeb = hasChip('chips-plat','web');
  const hasCRM = hasChip('chips-canal','crm');
  const lw = document.getElementById('lw-val')?.textContent || '?';

  const deTasks = [
    { t: `Extrair dados do BigQuery: GA4 events, com ${lw} dias extras antes do perÃ­odo de anÃ¡lise`, auto: true, reason: 'PerÃ­odo calculado com lookback sugerida' },
    hasApp && hasWeb ? { t: '(!) Validar User ID cross-platform antes de qualquer join (query de diagnÃ³stico)', auto: true, reason: 'Web + App  --  risco ALTO detectado', crit: true } : null,
    hasCRM ? { t: 'Unificar dados de GA4 + CRM por User ID / identificador mapeado', auto: true, reason: 'CRM Ã© canal ativo' } : null,
    { t: 'Aplicar agrupamento de canais (CASE WHEN conforme tabela da Etapa 3)', auto: false },
    { t: 'Filtrar conversÃ£o: evento definido na Etapa 3, 1a conversÃ£o por usuÃ¡rio', auto: false },
    hasApp ? { t: 'Tratar quebra de sessÃ£o via deep link / Unilink para app', auto: true, reason: 'App ativo  --  ponto cego mapeado na Etapa 2' } : null,
    { t: 'Transformar base de eventos -> base de jornadas (uma linha por jornada por usuÃ¡rio)', auto: false },
    { t: 'Validar volume: no de jornadas conversoras e nÃ£o conversoras', auto: false },
    { t: 'ğŸ”´ Compartilhar base com DS para revisÃ£o ANTES de rodar o modelo', auto: false },
    { t: 'Documentar queries, decisÃµes tÃ©cnicas e limitaÃ§Ãµes no repositÃ³rio', auto: false },
  ].filter(Boolean);

  const dsTasks = [
    { t: 'Receber e revisar base de jornada do DE  --  alinhar estrutura antes de avanÃ§ar', auto: false },
    { t: 'Executar EDA: todas as perguntas definidas na Etapa 3', auto: false },
    { t: `Validar lookback window de ${lw} dias empiricamente (% de jornadas encerradas por no de dias)`, auto: true, reason: `Lookback ${lw} dias sugerida  --  confirme na EDA` },
    { t: 'Configurar e executar modelo Markov (biblioteca Jatoox)', auto: false },
    { t: 'Extrair efeito de remoÃ§Ã£o e matriz de transiÃ§Ã£o entre canais', auto: false },
    { t: 'Comparar resultados com Last Click (baseline obrigatÃ³rio para toda anÃ¡lise)', auto: false },
    { t: 'Executar para 2o perÃ­odo (se definido na Etapa 3)', auto: false },
    { t: 'Versionar notebooks no GitHub (organizado, comentado, reproduzÃ­vel)', auto: false },
  ];

  const qInputs = [...document.querySelectorAll('#q-list .q-input')].map(i => i.value.trim()).filter(Boolean);
  const baTasks = [
    ...qInputs.map(q => ({ t: `Responder: "${q}"`, auto: true, reason: 'Pergunta registrada na Etapa 1' })),
    { t: 'Estruturar storytelling: papel de cada canal (Introdutor / Engajador / Conversor)', auto: false },
    { t: 'Elaborar recomendaÃ§Ãµes de otimizaÃ§Ã£o de investimento por funil', auto: false },
    { t: 'Apresentar limitaÃ§Ãµes e pontos cegos ao cliente de forma clara e objetiva', auto: false },
    { t: 'Revisar apresentaÃ§Ã£o completa com DE e DS antes de ir ao cliente', auto: false },
  ];

  function renderList(tasks, elId, autoClass) {
    document.getElementById(elId).innerHTML = tasks.map((t, i) => `
      <div class="check-row${t.auto ? ' ' + autoClass : ''}${t.crit ? ' crit' : ''}" onclick="toggleCheck4(this)">
        <div class="chkbox">v</div>
        <div style="flex:1;">
          <div class="check-text">${t.t}</div>
          ${t.auto ? `<div class="check-meta"><span class="badge badge-auto">* AUTO</span> ${t.reason}${t.crit ? ' <span class="badge" style="background:var(--danger);color:#fff;border:none;font-size:9px;">CRÃTICO</span>' : ''}</div>` : ''}
        </div>
      </div>`).join('');
  }

  renderList(deTasks, 'e4-de', 'auto-de');
  renderList(dsTasks, 'e4-ds', 'auto-ds');
  renderList(baTasks, 'e4-ba', 'auto-ba');
  updateProgress4();
}

// ===============================================
// INTERACTIONS
// ===============================================
function toggleCheck(el) {
  el.classList.toggle('checked');
  el.querySelector('.chkbox').textContent = el.classList.contains('checked') ? 'v' : '';
}

function toggleCheck4(el) {
  el.classList.toggle('checked');
  el.querySelector('.chkbox').textContent = el.classList.contains('checked') ? 'v' : '';
  updateProgress4();
}

function updateProgress4() {
  const all = document.querySelectorAll('#view-4 .check-row');
  const done = document.querySelectorAll('#view-4 .check-row.checked');
  const pct = all.length ? Math.round(done.length / all.length * 100) : 0;
  const bar = document.getElementById('e4-bar');
  const lbl = document.getElementById('e4-pct');
  if (bar) { bar.style.width = pct + '%'; bar.className = 'progress-fill' + (pct === 100 ? ' done' : ''); }
  if (lbl) lbl.textContent = `${pct}% concluÃ­do (${done.length}/${all.length})`;
}

function toggleRisk(el) {
  const body = el.nextElementSibling;
  body.classList.toggle('visible');
  el.classList.toggle('open');
}

function selModel(el) {
  document.querySelectorAll('.model-opt').forEach(m => m.classList.remove('selected'));
  el.classList.add('selected');
}

function addQ() {
  const list = document.getElementById('q-list');
  const n = list.children.length + 1;
  const div = document.createElement('div');
  div.className = 'q-row';
  div.innerHTML = `<div class="q-num">${n}</div><input class="q-input" type="text" placeholder="Digite a pergunta do cliente..." oninput="onInput()" style="flex:1;border:none;border-radius:0;padding:0;background:transparent;box-shadow:none;font-size:13px;color:var(--text);">`;
  list.appendChild(div);
}

// ===============================================
// INIT
// ===============================================
// ===============================================
// VALIDATOR  --  OVERLAY
// ===============================================
function openValidator() {
  // pre-fill client from stage 1
  const vc = document.getElementById('vc-client');
  const c1 = document.getElementById('f-cliente');
  if (vc && !vc.value && c1 && c1.value)
    vc.value = c1.value.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');

  // pre-fill lookback from stage 1
  const vl = document.getElementById('vc-lw');
  const lw = document.getElementById('lw-val');
  if (vl && lw && lw.textContent !== ' -- ') vl.value = lw.textContent;

  // pre-fill conversion events from stage 1
  const convOn = [...document.querySelectorAll('#chips-conv .chip.on')].map(c => c.textContent.trim().toLowerCase());
  const vcChips = document.querySelectorAll('#vc-conv-chips .chip');
  vcChips.forEach(ch => {
    if (convOn.some(v => ch.textContent.trim().toLowerCase().includes(v) || v.includes(ch.textContent.trim().toLowerCase())))
      ch.classList.add('on');
  });

  document.getElementById('val-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  // gera config ao abrir
  setTimeout(() => { const cfg = generateValConfig(); const el = document.getElementById('val-config-out'); if(el) el.textContent = cfg; }, 120);
}
function closeValidator() {
  document.getElementById('val-overlay').classList.remove('open');
  document.body.style.overflow = '';
}
function closeValidatorOutside(e) {
  if (e.target === document.getElementById('val-overlay')) closeValidator();
}
function switchValTab(tab) {
  document.querySelectorAll('.val-tab').forEach((t,i) => {
    t.classList.toggle('vt-active', ['config','colab','results'][i] === tab);
  });
  document.querySelectorAll('.val-tab-pane').forEach(p => p.classList.remove('vp-active'));
  document.getElementById('vtp-' + tab).classList.add('vp-active');
  if (tab === 'colab') { const cfg = generateValConfig(); const el = document.getElementById('val-config-out'); if(el) el.textContent = cfg; }
  if (tab === 'results' && !window._valResults) { document.getElementById('vr-input-area').style.display = 'block'; document.getElementById('vr-content').style.display = 'none'; }
}
function addVcConv() {
  const inp = document.getElementById('vc-conv-custom');
  if (!inp || !inp.value.trim()) return;
  const chips = document.getElementById('vc-conv-chips');
  const d = document.createElement('div');
  d.className = 'chip on'; d.textContent = inp.value.trim();
  d.onclick = function() { chip(this); };
  chips.appendChild(d);
  inp.value = '';
}
function addVcCanal() {
  const list = document.getElementById('vc-canal-list');
  const d = document.createElement('div');
  d.style.cssText = 'display:grid;grid-template-columns:120px 1fr;gap:8px;margin-bottom:7px;align-items:center;';
  d.innerHTML = '<input type="text" placeholder="nome_canal" style="font-size:11px;font-weight:700;color:var(--de);"><input type="text" placeholder="var1, var2, var3" style="font-size:11px;">';
  list.appendChild(d);
}

// === VALIDATOR ENGINE (simulado) ===
function getVcConfig() {
  const uid   = parseFloat(document.getElementById('vc-uid')?.value || 40) / 100;
  const dup   = parseFloat(document.getElementById('vc-dup')?.value || 1)  / 100;
  const divg  = parseFloat(document.getElementById('vc-div')?.value || 20) / 100;
  const utm   = parseFloat(document.getElementById('vc-utm')?.value || 30) / 100;
  const vol   = parseInt(document.getElementById('vc-vol')?.value  || 5);
  const adid  = parseFloat(document.getElementById('vc-adid')?.value|| 60) / 100;
  const hist  = parseInt(document.getElementById('vc-hist')?.value  || 90);
  const lw    = parseInt(document.getElementById('vc-lw')?.value    || 30);
  const convs = [...document.querySelectorAll('#vc-conv-chips .chip.on')].map(c => c.textContent.trim());

  // canal map
  const canalMap = {};
  document.querySelectorAll('#vc-canal-list > div').forEach(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length >= 2) {
      const key = inputs[0].value.trim();
      const vals = inputs[1].value.split(',').map(v => v.trim()).filter(Boolean);
      if (key && vals.length) canalMap[key] = vals;
    }
  });

  return { uid, dup, divg, utm, vol, adid, hist, lw, convs, canalMap };
}

// Pseudo-random seeded
function seededRand(seed) {
  let s = seed;
  return function() {
    s = (s * 9301 + 49297) % 233280;
    return s / 233280;
  };
}

function runValidatorSimulation(cfg) {
  const rand = seededRand(Date.now() % 10000);
  const results = [];

  // 1. Cobertura Temporal GA4
  const daysGa4 = Math.floor(rand() * 10) + (cfg.hist - 5);
  const gaps = rand() < 0.3 ? Math.floor(rand() * 3) + 1 : 0;
  results.push({
    dimension: 'Cobertura Temporal', source: 'ga4',
    metric: 'dias_disponiveis_ga4',
    value: daysGa4, threshold: cfg.hist,
    status: daysGa4 >= cfg.hist && gaps === 0 ? 'PASS' : daysGa4 >= cfg.hist ? 'WARN' : 'FAIL',
    detail: `${daysGa4} dias disponÃ­veis (mÃ­nimo: ${cfg.hist}). Gaps: ${gaps} dia(s) faltando.`
  });

  // 2. Cobertura Temporal AF
  const daysAf = Math.floor(rand() * 6) + (cfg.hist - 3);
  results.push({
    dimension: 'Cobertura Temporal', source: 'appsflyer',
    metric: 'dias_disponiveis_appsflyer',
    value: daysAf, threshold: cfg.hist,
    status: daysAf >= cfg.hist ? 'PASS' : 'WARN',
    detail: `${daysAf} dias disponÃ­veis no Appsflyer.`
  });

  // 3. Cobertura User ID GA4
  const uidCov = parseFloat((0.25 + rand() * 0.45).toFixed(3));
  results.push({
    dimension: 'Cobertura de Identidade', source: 'ga4',
    metric: 'pct_user_id_ga4_conversoes',
    value: uidCov, threshold: cfg.uid,
    status: uidCov >= cfg.uid ? 'PASS' : uidCov >= cfg.uid * 0.75 ? 'WARN' : 'FAIL',
    detail: `${(uidCov*100).toFixed(1)}% das conversÃµes tÃªm user_id preenchido.`
  });

  // 4. Advertising ID AF
  const adidCov = parseFloat((0.45 + rand() * 0.45).toFixed(3));
  results.push({
    dimension: 'Cobertura de Identidade', source: 'appsflyer',
    metric: 'pct_advertising_id_appsflyer',
    value: adidCov, threshold: cfg.adid,
    status: adidCov >= cfg.adid ? 'PASS' : 'WARN',
    detail: `${(adidCov*100).toFixed(1)}% com advertising_id.`
  });

  // 5. UTMs nulos
  const utmNull = parseFloat((0.05 + rand() * 0.40).toFixed(3));
  const unknownCh = Math.floor(rand() * 5);
  results.push({
    dimension: 'Qualidade de UTMs', source: 'ga4',
    metric: 'pct_source_nulo_ou_not_set',
    value: utmNull, threshold: cfg.utm,
    status: utmNull <= cfg.utm ? 'PASS' : utmNull <= cfg.utm * 1.5 ? 'WARN' : 'FAIL',
    detail: `${(utmNull*100).toFixed(1)}% de eventos sem source/medium vÃ¡lido.`
  });
  results.push({
    dimension: 'Qualidade de UTMs', source: 'ga4',
    metric: 'canais_nao_mapeados',
    value: unknownCh, threshold: 0,
    status: unknownCh === 0 ? 'PASS' : 'WARN',
    detail: unknownCh === 0 ? 'Todos os canais estÃ£o mapeados.' : `${unknownCh} valor(es) de source nÃ£o mapeado(s).`
  });

  // 6. Duplicatas
  const dupRate = parseFloat((rand() * 0.04).toFixed(4));
  results.push({
    dimension: 'Duplicatas', source: 'ga4',
    metric: 'pct_duplicatas_ga4',
    value: dupRate, threshold: cfg.dup,
    status: dupRate <= cfg.dup ? 'PASS' : dupRate <= cfg.dup * 3 ? 'WARN' : 'FAIL',
    detail: `${(dupRate*100).toFixed(2)}% de linhas duplicadas nas conversÃµes.`
  });

  // 7. Volume
  const avgVol = parseFloat((3 + rand() * 50).toFixed(1));
  const daysBelow = avgVol >= cfg.vol ? 0 : Math.floor(rand() * 10) + 1;
  results.push({
    dimension: 'Volume de ConversÃµes', source: 'ga4',
    metric: 'media_conversoes_dia_ga4',
    value: avgVol, threshold: cfg.vol,
    status: daysBelow === 0 ? 'PASS' : daysBelow <= 5 ? 'WARN' : 'FAIL',
    detail: `MÃ©dia de ${avgVol} conversÃµes/dia. ${daysBelow} dia(s) abaixo do mÃ­nimo (${cfg.vol}).`
  });

  // 8. ConsistÃªncia GA4 vs AF
  const divVal = parseFloat((0.05 + rand() * 0.35).toFixed(3));
  const daysOver = divVal > cfg.divg ? Math.floor(rand() * 15) + 1 : 0;
  results.push({
    dimension: 'ConsistÃªncia entre Fontes', source: 'cross',
    metric: 'divergencia_media_ga4_vs_appsflyer',
    value: divVal, threshold: cfg.divg,
    status: divVal <= cfg.divg ? 'PASS' : divVal <= cfg.divg * 1.5 ? 'WARN' : 'FAIL',
    detail: `DivergÃªncia mÃ©dia de ${(divVal*100).toFixed(1)}%. ${daysOver} dia(s) acima do limite.`
  });

  return results;
}

async function runValidator() {
  const btn = document.getElementById('val-run-btn');
  const log = document.getElementById('val-run-log');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin">@</span> Executando validaÃ§Ã£o...';
  log.style.display = 'block';
  log.textContent = '';

  const lines = [
    'ğŸ”„ Inicializando validador...',
    'ğŸ“¡ Conectando Ã  fonte de dados (mockado)...',
    'ğŸ“¥ Carregando eventos GA4  --  90 dias...',
    'ğŸ“¥ Carregando eventos Appsflyer  --  90 dias...',
    'ğŸ” [1/6] Verificando cobertura temporal...',
    'ğŸ” [2/6] Verificando cobertura de identidade (user_id)...',
    'ğŸ” [3/6] Analisando qualidade de UTMs e canais...',
    'ğŸ” [4/6] Detectando duplicatas nas conversÃµes...',
    'ğŸ” [5/6] Validando volume diÃ¡rio de conversÃµes...',
    'ğŸ” [6/6] Verificando consistÃªncia GA4 vs Appsflyer...',
    'ğŸ“Š Gerando relatÃ³rio...',
  ];

  for (const line of lines) {
    log.textContent += line + '\n';
    await new Promise(r => setTimeout(r, 200 + Math.random() * 150));
  }

  const cfg = getVcConfig();
  const results = runValidatorSimulation(cfg);
  const statuses = results.map(r => r.status);
  const overall = statuses.includes('FAIL') ? 'FAIL' : statuses.includes('WARN') ? 'WARN' : 'PASS';
  const passes = statuses.filter(s => s==='PASS').length;
  const warns  = statuses.filter(s => s==='WARN').length;
  const fails  = statuses.filter(s => s==='FAIL').length;

  log.textContent += `\n[OK] ${passes} PASS  (!) ${warns} WARN  [X] ${fails} FAIL\n`;
  log.textContent += `\nStatus geral: ${overall === 'PASS' ? '[OK]' : overall === 'WARN' ? '(!)' : '[X]'} ${overall}\n`;

  btn.disabled = false;
  btn.innerHTML = '> Executar Novamente';

  // Update badge
  updateValBadge(overall);
  // Store & render results
  window._valResults = { overall, results };
  renderValResults(results, overall);
  // Propagate to stage alerts
  propagateValAlerts(results);
  // Auto-switch to results tab
  // auto-switch removido  --  fluxo agora Ã© manual via cola JSON
}

const STATUS_BG_V    = { PASS:'#ecfdf5', WARN:'#fffbeb', FAIL:'#fef2f2' };
const STATUS_COLOR_V = { PASS:'#065f46', WARN:'#92400e', FAIL:'#991b1b' };
const STATUS_ICON_V  = { PASS:'[OK]', WARN:'(!)', FAIL:'[X]' };
const VERDICTS = {
  PASS: '[OK] Fontes aprovadas  --  pode iniciar a construÃ§Ã£o da SOT de MTA.',
  WARN: '(!) Fontes com pontos de atenÃ§Ã£o  --  alinhe os WARNs com BA+DE antes de construir.',
  FAIL: '[X] Fontes com problemas crÃ­ticos  --  resolva os FAILs antes de prosseguir.'
};

function updateValBadge(overall) {
  const badge = document.getElementById('val-badge');
  const text  = document.getElementById('val-badge-text');
  if (!badge || !text) return;
  badge.className = 'val-status-badge vb-' + overall.toLowerCase();
  text.textContent = overall === 'PASS' ? 'PASS [OK]' : overall === 'WARN' ? 'WARN (!)' : 'FAIL [X]';
}

function renderValResults(results, overall) {
  document.getElementById('vr-empty').style.display = 'none';
  document.getElementById('vr-content').style.display = 'block';

  // Banner
  const banner = document.getElementById('vr-banner');
  banner.style.cssText = `background:${STATUS_BG_V[overall]};border:1px solid ${overall==='FAIL'?'#fca5a5':overall==='WARN'?'#fcd34d':'#6ee7b7'};border-radius:var(--r-sm);padding:14px 16px;`;
  banner.innerHTML = `<div style="font-size:15px;font-weight:800;color:${STATUS_COLOR_V[overall]};margin-bottom:4px;">${STATUS_ICON_V[overall]} ${overall}</div><div style="font-size:12px;color:${STATUS_COLOR_V[overall]};opacity:.85;">${VERDICTS[overall]}</div>`;

  // Dims
  // Group by dimension
  const groups = {};
  results.forEach(r => { if(!groups[r.dimension]) groups[r.dimension] = []; groups[r.dimension].push(r); });
  const dims = document.getElementById('vr-dims');
  dims.innerHTML = '';
  Object.entries(groups).forEach(([dim, checks]) => {
    const dimStatus = checks.some(c=>c.status==='FAIL')?'FAIL':checks.some(c=>c.status==='WARN')?'WARN':'PASS';
    const details = checks.map(c => {
      const valStr = c.value < 2 ? `${(c.value*100).toFixed(1)}%` : String(c.value);
      const thrStr = c.threshold < 2 && c.threshold > 0 ? `${(c.threshold*100).toFixed(0)}%` : String(c.threshold);
      return `<div style="display:flex;align-items:flex-start;gap:8px;padding:7px 0;border-bottom:1px solid var(--border);">
        <span class="status-pill sp-${c.status.toLowerCase()}">${STATUS_ICON_V[c.status]} ${c.status}</span>
        <div style="flex:1;">
          <div style="font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--de);margin-bottom:2px;">${c.metric}</div>
          <div style="font-size:12px;color:var(--text-2);">${c.detail}</div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="font-size:13px;font-weight:800;color:${STATUS_COLOR_V[c.status]};">${valStr}</div>
          <div style="font-size:10px;color:var(--text-3);">thr: ${thrStr}</div>
        </div>
      </div>`;
    }).join('');
    dims.innerHTML += `<div class="dim-card">
      <div class="dim-card-head" onclick="this.nextElementSibling.classList.toggle('dc-open'); this.querySelector('.dc-arr').style.transform = this.nextElementSibling.classList.contains('dc-open') ? 'rotate(180deg)' : ''">
        <span class="status-pill sp-${dimStatus.toLowerCase()}">${STATUS_ICON_V[dimStatus]} ${dimStatus}</span>
        <span class="dim-label">${dim}</span>
        <span class="dc-arr" style="color:var(--text-3);font-size:11px;transition:transform .2s;">v</span>
      </div>
      <div class="dim-card-body">${details}</div>
    </div>`;
  });

  // Issues
  const issues = results.filter(r => r.status !== 'PASS');
  const issuesEl = document.getElementById('vr-issues');
  if (issues.length) {
    issuesEl.innerHTML = `<div class="alert alert-${overall==='FAIL'?'danger':'warn'}">
      <div class="alert-title">ğŸ“‹ ${issues.length} ponto(s) de atenÃ§Ã£o  --  propagados para o planejamento</div>
      <ul style="margin:8px 0 0 4px;padding-left:14px;">
        ${issues.map(r=>`<li style="margin-bottom:4px;font-size:11px;">[${r.dimension}] ${r.detail}</li>`).join('')}
      </ul>
    </div>`;
  } else {
    issuesEl.innerHTML = `<div class="alert alert-success"><div class="alert-title">[OK] Todos os checks passaram  --  base aprovada para construÃ§Ã£o da SOT</div></div>`;
  }
}

// === VALIDATOR  --  CONFIG GENERATOR ===
function generateValConfig() {
  const client  = document.getElementById('vc-client')?.value || 'cliente';
  const project = document.getElementById('vc-project')?.value || 'meu-projeto-gcp';
  const ga4     = document.getElementById('vc-ga4')?.value || 'analytics_XXXXXXX';
  const af      = document.getElementById('vc-af')?.value || 'appsflyer_data';
  const lw      = document.getElementById('vc-lw')?.value || '30';
  const hist    = document.getElementById('vc-hist')?.value || '90';
  const uid     = document.getElementById('vc-uid')?.value || '40';
  const dup     = document.getElementById('vc-dup')?.value || '1';
  const div_    = document.getElementById('vc-div')?.value || '20';
  const utm     = document.getElementById('vc-utm')?.value || '30';
  const vol     = document.getElementById('vc-vol')?.value || '5';
  const adid    = document.getElementById('vc-adid')?.value || '60';

  const convs = [...document.querySelectorAll('#vc-conv-chips .chip.on')]
    .map(c => `"${c.textContent.trim()}"`)
    .join(', ');

  const canalLines = [...document.querySelectorAll('#vc-canal-list > div')].map(row => {
    const inputs = row.querySelectorAll('input');
    if (inputs.length < 2) return null;
    const key  = inputs[0].value.trim();
    const vals = inputs[1].value.split(',').map(v => `"${v.trim()}"`).filter(v => v !== '""').join(', ');
    return key && vals ? `        "${key}": [${vals}]` : null;
  }).filter(Boolean).join(',\n');

  return `CONFIG = {
    "client": "${client}",
    "project_id": "${project}",
    "datasets": {
        "ga4": "${ga4}",
        "appsflyer": "${af}"
    },

    # -- Janela de atribuiÃ§Ã£o -----------------
    "lookback_window_days": ${lw},
    "min_history_days": ${hist},

    # -- Eventos de conversÃ£o -----------------
    "conversion_events": [${convs}],

    # -- Campos de identidade -----------------
    "identity_fields": {
        "primary": "user_id",
        "fallback": "user_pseudo_id"
    },

    # -- Mapeamento de canais -----------------
    "channel_standardization": {
${canalLines}
    },

    # -- Thresholds de qualidade --------------
    "thresholds": {
        "min_user_id_coverage":        ${parseFloat(uid)/100},
        "max_duplicate_rate":          ${parseFloat(dup)/100},
        "max_source_divergence":       ${parseFloat(div_)/100},
        "max_null_utm_rate":           ${parseFloat(utm)/100},
        "min_conversion_volume_daily": ${vol},
        "min_advertising_id_coverage": ${parseFloat(adid)/100}
    }
}

print("[OK] Config carregado para:", CONFIG["client"])`;
}

function openValidatorColab() {
  openValidator();
  // pequeno delay para o painel abrir
  setTimeout(() => {
    const cfg = generateValConfig();
    const el = document.getElementById('val-config-out');
    if (el) el.textContent = cfg;
    switchValTab('colab');
  }, 80);
}

function copyValConfig() {
  const cfg = generateValConfig();
  const el = document.getElementById('val-config-out');
  if (el) el.textContent = cfg;
  navigator.clipboard.writeText(cfg).then(() => {
    const btn = event.target;
    const orig = btn.textContent;
    btn.textContent = 'v Copiado!';
    setTimeout(() => btn.textContent = orig, 1500);
  }).catch(() => {
    // fallback para browsers sem clipboard API
    const ta = document.createElement('textarea');
    ta.value = cfg; ta.style.position = 'fixed'; ta.style.opacity = '0';
    document.body.appendChild(ta); ta.select();
    document.execCommand('copy');
    document.body.removeChild(ta);
  });
}

// atualiza CONFIG ao abrir a aba Colab
function onOpenColab() {
  const cfg = generateValConfig();
  const el = document.getElementById('val-config-out');
  if (el) el.textContent = cfg;
}

// === VALIDATOR  --  JSON IMPORT ===
function loadMockJson() {
  const mock = [
    {"dimension":"Cobertura Temporal","status":"PASS","metric":"dias_disponiveis_ga4","value":88,"threshold":90,"detail":"88 dias disponÃ­veis (mÃ­nimo: 90). Gaps: 2 dia(s) faltando.","source":"ga4"},
    {"dimension":"Cobertura Temporal","status":"PASS","metric":"dias_disponiveis_appsflyer","value":90,"threshold":90,"detail":"90 dias disponÃ­veis no Appsflyer.","source":"appsflyer"},
    {"dimension":"Cobertura de Identidade","status":"WARN","metric":"pct_user_id_ga4_conversoes","value":0.38,"threshold":0.40,"detail":"38.0% das conversÃµes tÃªm user_id preenchido (190/500).","source":"ga4"},
    {"dimension":"Cobertura de Identidade","status":"PASS","metric":"pct_advertising_id_appsflyer","value":0.71,"threshold":0.60,"detail":"71.0% com advertising_id | 35.0% com customer_user_id.","source":"appsflyer"},
    {"dimension":"Qualidade de UTMs","status":"PASS","metric":"pct_source_nulo_ou_not_set","value":0.12,"threshold":0.30,"detail":"12.0% de eventos sem source/medium vÃ¡lido.","source":"ga4"},
    {"dimension":"Qualidade de UTMs","status":"WARN","metric":"canais_nao_mapeados","value":3,"threshold":0,"detail":"3 valor(es) de source nÃ£o mapeado(s): ['tiktok_int','affiliate_net','unknown']","source":"ga4"},
    {"dimension":"Duplicatas","status":"WARN","metric":"pct_duplicatas_ga4","value":0.022,"threshold":0.01,"detail":"11 linhas duplicadas em 500 conversÃµes (2.20%).","source":"ga4"},
    {"dimension":"Volume de ConversÃµes","status":"PASS","metric":"media_conversoes_dia_ga4","value":23,"threshold":5,"detail":"MÃ©dia de 23 conversÃµes/dia. 0 dia(s) abaixo do mÃ­nimo (5).","source":"ga4"},
    {"dimension":"ConsistÃªncia entre Fontes","status":"PASS","metric":"divergencia_media_ga4_vs_appsflyer","value":0.14,"threshold":0.20,"detail":"DivergÃªncia mÃ©dia de 14.0%. 0 dia(s) acima do limite de 20%.","source":"cross"}
  ];
  document.getElementById('vr-json').value = JSON.stringify(mock, null, 2);
}

function processJson() {
  const raw = document.getElementById('vr-json')?.value?.trim();
  if (!raw) return;
  let data;
  try { data = JSON.parse(raw); }
  catch(e) { alert('JSON invÃ¡lido:\n' + e.message); return; }
  if (!Array.isArray(data) || !data.length) { alert('JSON vazio ou formato incorreto.'); return; }

  const statuses = data.map(r => r.status);
  const overall  = statuses.includes('FAIL') ? 'FAIL' : statuses.includes('WARN') ? 'WARN' : 'PASS';

  updateValBadge(overall);
  window._valResults = { overall, results: data };
  renderValResults(data, overall);
  propagateValAlerts(data);

  // hide input, show results
  document.getElementById('vr-input-area').style.display = 'none';
  document.getElementById('vr-content').style.display = 'block';
}


function propagateValAlerts(results) {
  const issues = results.filter(r => r.status !== 'PASS');
  if (!issues.length) return;
  const html = issues.map(r => `<div class="alert alert-${r.status==='FAIL'?'danger':'warn'} fade-up">
    <div class="alert-title">[Validador] ${r.dimension}  --  ${r.status}</div>
    <div class="alert-body">${r.detail}</div>
  </div>`).join('');
  ['1','2','3','4'].forEach(n => {
    const el = document.getElementById('alerts-' + n);
    if (el) el.innerHTML = html + el.innerHTML;
  });
}


function addChip(inputId, chipsId) {
  const inp = document.getElementById(inputId);
  if (!inp) return;
  const val = inp.value.trim();
  if (!val) return;
  const container = document.getElementById(chipsId);
  if (!container) return;
  // Verificar duplicata
  const existing = [...container.querySelectorAll('.chip')]
    .map(c => c.textContent.trim().toLowerCase());
  if (existing.includes(val.toLowerCase())) {
    inp.value = '';
    return;
  }
  const chip = document.createElement('div');
  chip.className = 'chip on custom-chip';
  chip.textContent = val;
  chip.onclick = function() {
    // chip customizado pode ser removido com duplo clique
    if (this.classList.contains('on')) {
      this.classList.remove('on');
    } else {
      this.classList.add('on');
    }
    onInput();
  };
  // botÃ£o remover no chip customizado
  const rm = document.createElement('span');
  rm.textContent = ' Ã—';
  rm.style.cssText = 'opacity:.5;cursor:pointer;margin-left:2px;font-size:13px;';
  rm.onclick = function(e) {
    e.stopPropagation();
    chip.remove();
    onInput();
  };
  chip.appendChild(rm);
  container.appendChild(chip);
  inp.value = '';
  onInput();
}

onInput();
</script>
</body>
</html>
